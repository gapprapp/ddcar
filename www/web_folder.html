<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>หมวดหมู่สินค้า</title>

  <!-- Bootstrap Import -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ" crossorigin="anonymous">

  <!-- Super cool dialog-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>	
	
	<!-- Loading -->
	<link rel="stylesheet" href="css/easy-loading.css">
	<script src="js/easy-loading.js"></script>

	<!-- QRcode -->
	<script type="text/javascript" src="js/qrcode.min.js"></script>
	<script type="text/javascript" src="js/jQuery.print.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet"> 
  <!-- Main -->
  <link href="css/untitled.css" rel="stylesheet">
  <link href="css/web_folder.css" rel="stylesheet">  

  <style>
  	.i-trash{
  		float: right; margin-right: 10%; color: white;
  	}
  	.i-edit{
  		float: right; margin-right: 6%; color: white;
  	}
  </style>

  <script>
	arr_prod = [];
	var num_prod = 0,from;
  	$(document).ready(function() {
		localStorage.stack_folder = "";
		url = new URL(window.location.href);		
		from = url.searchParams.get("from");
		$.ajax({
			type: "POST",
			url:"php/get_folder.php",
			crossDomain: true,
			data: {'parent' : "car"},  
			beforeSend: function(){
				EasyLoading.show({                           
						text: "กำลังโหลด"                            
					});			
			},             
			success: function(data){  
				EasyLoading.hide();			          
				var obj = jQuery.parseJSON(data);              
				if(obj){				           
					$.each(obj, function(i, field){
						if(obj.length-1 > i){
							text_html = "<h3 class='brand' onclick='showsub(\""+obj[i].title+"\",1)'>"+obj[i].title+"</h3>";
							$("#col-brand").append(text_html);
							index = i;
						}                                                 
					});               
				}                               
				                          
			}               
		});
		
  	});	

	function next(){
	  if(num_prod == 0){
		  return 0;
	  }
	  json = [];
      for(var i = 0 ; i < arr_prod.length ; i++){
        if(arr_prod[i].prod_id != 0){
            item = {}
            item["prod_id"] = arr_prod[i].prod_id;  
			item["name"] = arr_prod[i].name;           
            json.push(item);               
        }
      }
      if(from == "import"){
          localStorage.setItem('arr_prod_i', JSON.stringify(json)); 
          window.location = "web_import.html";
        }else if(from == "export"){
          localStorage.setItem('arr_prod_e', JSON.stringify(json)); 
          window.location = "web_export.html";
        }else if(from == "sale"){
          localStorage.setItem('arr_prod_s', JSON.stringify(json)); 
          window.location = "web_sale.html";
        }else if(from == "stock"){
          localStorage.setItem('arr_prod_st', JSON.stringify(json)); 
          window.location = "web_stock.html";
        }        
	}

	function showsub(arg,arg2){
		console.log(arg);
		if(arg2){
			$("#append-title").empty();
			localStorage.stack_folder = "";
		}
		if(localStorage.stack_folder){
			var retrievedObject = localStorage.getItem('stack_folder');
			var arr_data = JSON.parse(retrievedObject); 			
			$('#i-back').prop('hidden',false);
			if(arr_data.length == 0){
				var arr_data = [];    
				$('#i-back').prop('hidden',true); 
			} 
		}else{
			var arr_data = [];    
			$('#i-back').prop('hidden',true);   
		}
		arr_data.push(arg); 
		localStorage.setItem('stack_folder', JSON.stringify(arr_data));		
		$("#append-prod").empty();
		//$("#append-title").append('<h5 id="'+arg+'" onclick="page_back(\''+arg+'\')" class="prod-title">'+arg+'</h5>');
    // ลองแก้เป็นแบบนี้ดู
//$('.prod-title').append('<span id="'+arg+'" onclick="page_back(\''+arg+'\')">'+arg+'</span>');
		$.ajax({
			type: "POST",
			url:"php/get_folder.php",
			crossDomain: true,
			data: {'parent' : arg},  
			beforeSend: function(){
				EasyLoading.show({                           
						text: "กำลังโหลด"                            
					});			
			},             
			success: function(data){  
				EasyLoading.hide();
				if(data != "last node"){
					var obj = jQuery.parseJSON(data); 
					$('#col-prod').prop('hidden',false);             
					if(obj[obj.length-1] == "last node"){               
					$.each(obj, function(i, field){
						if(obj.length-1 > i){
							if(i % 2 == 0){
								text_html = '<h5 id="prod-'+obj[i].title+'" class="prod-odd" onclick="choose('+obj[i].title+')"><input type="checkbox">'+obj[i][2]+'<i class="fas fa-trash i-trash" hidden></i><i class="fas fa-pen i-edit" hidden></i></h5>';
							}else{
								text_html = '<h5 id="prod-'+obj[i].title+'" class="prod-even" onclick="choose('+obj[i].title+')"><input type="checkbox">'+obj[i][2]+'<i class="fas fa-trash i-trash" hidden></i><i class="fas fa-pen i-edit" hidden></i></h5>';
							}                     
						$("#append-prod").append(text_html);                      
						}                                                 
					});                                                                
					}else{					              
						$.each(obj, function(i, field){
							if(obj.length-1 > i){
								if(i % 2 == 0){
									text_html = '<h5 class="prod-odd" onclick="showsub(\''+obj[i].title+'\')"><i class="fas fa-folder"></i>'+ obj[i].title +'<i class="fas fa-trash i-trash" hidden></i><i class="fas fa-pen i-edit" hidden></i></h5>';
								}else{
									text_html = '<h5 class="prod-even" onclick="showsub(\''+obj[i].title+'\')"><i class="fas fa-folder"></i>'+ obj[i].title +'<i class="fas fa-trash i-trash" hidden></i><i class="fas fa-pen i-edit" hidden></i></h5>';
								}
								$("#append-prod").append(text_html);							
							}                                                 
						});               
					}
				}			          
								                          
			}               
		});
	}

	function choose(arg2){
		arg = $('#prod-'+arg2).find('input[type=checkbox]');
		name = $('#prod-'+arg2).text();
		check = arg.prop('checked');	
		isenable = !arg.is(":disabled");
		if(check == false && isenable){
			arg.prop('checked', true);
			var ch = false;
			for(var i = 0 ; i < arr_prod.length ; i++){
				if(arr_prod[i].arg == arg2){
					arr_prod[i].prod_id = arg2;
					ch = true;
					break;
				}
			}
			if(!ch){          
				item = {};   
				item ["arg"] = arg2;        
				item ["prod_id"] = arg2; 
				item ["name"] = name;        
				arr_prod.push(item);          
			}   
			num_prod++;				
			$('#btn-next').text("เลือกสินค้า("+num_prod+")");  
		}else if(isenable){
			arg.prop('checked', false);
			for(var i = 0 ; i < arr_prod.length ; i++){
				if(arr_prod[i].arg == arg2){
					arr_prod[i].prod_id = 0;
					break;
				}
			} 
			num_prod--;
			$('#btn-next').text("เลือกสินค้า("+num_prod+")");
		}
	}

	function page_back(arg){
		var retrievedObject = localStorage.getItem('stack_folder');
		var arr_data = JSON.parse(retrievedObject); 
		if(arg){
			for(var i = 1 ; i <= arr_data.length ; i++){
				$('#'+arr_data[arr_data.length-i]).remove();				
				if(arr_data[arr_data.length-i] == arg){
					arr_data.splice(arr_data.length-i,i);
					break;
				}				
			}			
			localStorage.setItem('stack_folder', JSON.stringify(arr_data));  
			showsub(arg);
		}else{
			for(var i = 1 ; i <= 2 ; i++){
				$('#'+arr_data[arr_data.length-i]).remove();
			}
			var data = arr_data[arr_data.length-2];		
			arr_data.splice(arr_data.length-2,2);
			localStorage.setItem('stack_folder', JSON.stringify(arr_data));  
			showsub(data);	
		}
			
	}   
  	/* Brand Zone */
  	function addbrandconfirm(){
  		brandname = $(".newbrand").val();
  		if(brandname != ""){
  			$("#brand-tools").after('<h3 class="brand">'+brandname+'</h3>');
  			$(".newbrand").remove();
  			$("#addbrandbtn").remove();
  		}else{
  			return 0;
  		}
  	}

  	function addbrandcancle(){
  		$(".newbrand").remove();
  		$("#addbrandbtn").remove();
  	}

  	function addbrand(){
  		//Clear
  			$(".brand").removeClass('delbrand');
  			$(".brand").removeClass('editbrand');
  			editbrandcancle();
  		//
  		if($(".newbrand").is(":visible")){
  			return 0;
  		}
  		$("#brand-tools").after('<input type="text" class="form-control text-center newbrand"><div id="addbrandbtn" class="row justify-content-center"><button class="btn btn-sm btn-success" style="margin-right: 10px; color: #fff" onclick="addbrandconfirm();">เพิ่ม</button><button class="btn btn-sm btn-danger" style="color: #fff" onclick="addbrandcancle();">ยกเลิก</button></div>');
  	}
	
  	function dialogbrandremove(arg){
  		$.confirm({
			icon: 'fa fa-warning',
			title: 'คุณต้องการลบ '+arg.text(),
			content: 'ต้องการลบรายการสินค้าออกจากรายการ!',
			buttons: {
				danger: {
					btnClass: 'btn-danger',
					text: 'ลบ',
					action: function () {	
						arg.remove();					
					}
				},
				ยกเลิก: function () {},
			}
		});
  	}

  	function removebrand(arg){
  		//Clear
  			$(".brand").removeClass('editbrand');
  			addbrandcancle();
  			editbrandcancle();
  		//
  		//alert(arg);
  		$("."+arg).attr('onclick', 'brandback("'+arg+'")');
  		$(".brand").addClass('delbrand');
  		$(".brand").attr('onclick', 'dialogbrandremove($(this))');
  	}

  	function brandback(arg){
  		if(arg == "fa-trash"){
  			$("."+arg).attr('onclick', 'removebrand("'+arg+'")');
  			$(".brand").removeClass('delbrand');
  			$(".brand").attr('onclick', 'showsub()');
  			$("#i-brand-add").attr('onclick', 'addbrand()');
  			$("#i-brand-edit").attr('onclick', 'editbrand("fa-pen")');
  		}else if(arg == "fa-pen"){
  			$("."+arg).attr('onclick', 'editbrand("'+arg+'")');
  			$(".brand").removeClass('editbrand');
  			$(".brand").attr('onclick', 'showsub()');
  			$("#i-brand-add").attr('onclick', 'addbrand()');
  			$("#i-brand-trash").attr('onclick', 'removebrand("fa-trash")');
  		}
  	}

  	function editbrandconfirm(){
  		brandname = $(".bluebrand").val();
  		if(brandname != ""){
  			$(".invis").text(brandname);
  			//alert($(".brand .invis").text());
  			$(".bluebrand").remove();
  			$("#editbrandbtn").remove();
  			$(".brand").prop('hidden', false);
  			$(".brand").removeClass('invis');
  		}else{
  			return 0;
  		}
  		$("#i-brand-edit").attr('onclick', 'brandback("fa-pen")');
  	}

  	function editbrandcancle(){
  		//arg.prop('hidden', false);
  		$(".bluebrand").remove();
  		$("#editbrandbtn").remove();
  		$(".brand").prop('hidden', false);
  		$(".brand").removeClass('invis');
  		$("#i-brand-edit").attr('onclick', 'brandback("fa-pen")');
  	}

  	function showbrandedit(arg){
  		$("#i-brand-edit").prop('onclick', '');
  		if($(".bluebrand").is(":visible")){
  			return 0;
  		}
  		arg.after('<input type="text" class="form-control text-center bluebrand" value="'+arg.text()+'"><div id="editbrandbtn" class="row justify-content-center"><button class="btn btn-sm btn-success" style="margin-right: 10px; color: #fff" onclick="editbrandconfirm();">ตกลง</button><button class="btn btn-sm btn-danger" style="color: #fff" onclick="editbrandcancle();">ยกเลิก</button></div>');
  		arg.addClass('invis');
  		arg.prop('hidden', true);
  	}

  	function editbrand(arg){
  		//Clear
  			$(".brand").removeClass('delbrand');
  			addbrandcancle();
  		//
  		$("."+arg).attr('onclick', 'brandback("'+arg+'")');
  		$(".brand").addClass('editbrand');
  		$(".brand").attr('onclick', 'showbrandedit($(this))');
  	}
  	
	/* Prod Zone */
  	function delnewprod(np){
  		$.confirm({
			icon: 'fa fa-warning',
			title: 'คุณต้องการลบ '+$("#newprod-"+np).text(),
			content: 'ต้องการลบรายการสินค้าออกจากรายการ!',
			buttons: {
				danger: {
					btnClass: 'btn-danger',
					text: 'ลบ',
					action: function () {	
						$("#newprod-"+np).remove(); 	
						if(np == 1){
							$("#div-btn").remove();
						}				
					}
				},
				ยกเลิก: function () {},
			}
		});
  	}

  	function addcancleall(){
  		for(var i = 1; i <= np; i++)
  			$("#newprod-"+i).remove();
  		$("#div-btn").remove();
  		np=0;
  	}

  	function addprodconfirm(np){
  		newprod = $("#newprod-"+np+" input[type='text']").val();
  		if(newprod == "") return 0;

  		$("#newprod-"+np+"input[type='text']").remove();
  		$("#newprod-"+np+"div").remove();
  		$("#newprod-"+np).text(newprod);
  		$("#newprod-"+np).prepend("<input type='checkbox'>");
  		$("#newprod-"+np).append('<i class="fas fa-trash" style="float: right; margin-right: 10%; color: white;" onclick="delnewprod('+np+')"></i>');

  		if(np == 1){
  			$("#newprod-"+np).after('<div id="div-btn" class="row justify-content-end" style="margin-right: 2%; margin-bottom: 20px;"><button class="btn btn-primary" style="margin-right: 10px;">บันทึก</button><button class="btn btn-danger" onclick="addcancleall();">ยกเลิก</button></div>');
  		}
  		addprod();
  	}

  	function addprodcancle(np){
  		$("#newprod-"+np).remove();
  		np--;
  	}
  	var np = 0;
  	function addprod(){
  		np++;
  		if($(".form-control").is(":visible")){np--; return 0;} 
  		// find even or odd
  		prooreven = $(".prod-title").next().attr('class');
  		var cls;
  		if(prooreven == "prod-odd"){
  			cls = "prod-even";
  		}else{
  			cls = "prod-odd";
  		}

  		$(".prod-title").after('<h5 id="newprod-'+np+'" class="'+cls+'">เพิ่มสินค้า : <input type="text" class="form-control" style="margin: 0; margin-top: 2px; margin-bottom: 10px; font-size: 1em; width: 70%;"><div class="row" style="padding-left: 2%;"><button class="btn btn-success" style="margin-right: 10px;" onclick="addprodconfirm('+np+');">เพิ่ม</button><button class="btn btn-danger" onclick="addprodcancle('+np+');">ยกเลิก</button></div></h5>');
  	}

  	function delspcfprod(arg){
  		$.confirm({
			icon: 'fa fa-warning',
			title: 'คุณต้องการลบ '+arg.text(),
			content: 'ต้องการลบรายการสินค้าออกจากรายการ!',
			buttons: {
				danger: {
					btnClass: 'btn-danger',
					text: 'ลบ',
					action: function () {	
						arg.remove(); 				
					}
				},
				ยกเลิก: function () {},
			}
		});
  	}
  	var p = 16; // number of prod
  	function removeprod(){
  		if($(".i-trash").is(":visible")){
  			$(".i-trash").prop('hidden', true);
  			$("input[type='checkbox']").prop('disabled', false);
  			for(var j = 1; j <= p; j++){
  			  	$("#prod-"+j).attr('onclick', '');
  			}
  			return 0;
  		}
  		$("input[type='checkbox']").prop('disabled', true);
  		$(".i-trash").prop('hidden', false);
  		for(var i = 1; i <= p; i++){
  			$("#prod-"+i).attr('onclick', 'delspcfprod($(this))');
  		}
  	}

  	var presymb;
  	function editspcfprod(arg){
  		if($("#editprod").is(":visible")){
  			return 0;
  		}
  		presymb = arg.find('input').attr('type');
  		if(presymb == undefined){
  			presymb = arg.find('i').attr('class').split('-')[1];
  		}
  		id = arg.attr("id");
  		cls = arg.attr("class");
  		// prod-id[1];
  		text = arg.text();
  		arg.text('แก้ไขรายการ : ');
  		//arg.append('<input type="checkbox" hidden>');
  		arg.after('<h5 id="editprod" class="'+cls+'">แก้ไขรายการ : <input type="text" class="form-control" style="margin: 0; margin-top: 2px; margin-bottom: 10px; font-size: 1em; width: 70%;" value="'+text+'"><div class="row" style="padding-left: 2%;"><button class="btn btn-primary" style="margin-right: 10px;" onclick="editprodconfirm(\''+text+'\',\''+id+'\')">บันทึกแก้ไข</button><button class="btn btn-danger" onclick="editprodcancle(\''+text+'\',\''+id+'\');">ยกเลิก</button></div></h5>');
  		arg.prop('hidden', true);
  	}

  	function editprodconfirm(arg1,arg2){
  		text = $("#editprod input").val();
  		$("#editprod").remove();
  		$("#"+arg2).text(text);
  		if(presymb == "checkbox"){
  			$("#"+arg2).prepend('<input type="checkbox" disabled>');
  		}else if(presymb == "folder"){
  			$("#"+arg2).prepend('<i class="fas fa-folder"></i>');
  		}
  		$("#"+arg2).append('<i class="fas fa-trash i-trash" hidden></i><i class="fas fa-pen i-edit"></i>');
  		$("#"+arg2).prop('hidden', false);
  	}

  	function editprodcancle(arg1, arg2){
  		$("#editprod").remove();
  		$("#"+arg2).text(arg1);
  		if(presymb == "checkbox"){
  			$("#"+arg2).prepend('<input type="checkbox" disabled>');
  		}else if(presymb == "folder"){
  			$("#"+arg2).prepend('<i class="fas fa-folder"></i>');
  		}
  		$("#"+arg2).append('<i class="fas fa-trash i-trash" hidden></i><i class="fas fa-pen i-edit"></i>');
  		$("#"+arg2).prop('hidden', false);
  		//alert($("#"+arg2).closest('input').attr('type'));
  	}

  	function editprod(){
  		if($(".i-edit").is(":visible")){
  			$(".i-edit").prop('hidden', true);
  			$("input[type='checkbox']").prop('disabled', false);
  			for(var j = 1; j <= p; j++){
  			  	$("#prod-"+j).attr('onclick', '');
  			}
  			return 0;
  		}
  		$("input[type='checkbox']").prop('disabled', true);
  		$(".i-edit").prop('hidden', false);
  		for(var i = 1; i <= p; i++){
  			$("#prod-"+i).attr('onclick', 'editspcfprod($(this))');
  		}
  	}
		  
  </script>
</head>
<body style="overflow: hidden">
	<div class="container-fullwidth justify-content-center h-100">
      	<div class="row" style="padding-left: 1.5%; padding-right: 1.5%; margin-top: 3%; margin-bottom: 15px; height: 85%;">
        	<div id="col-brand" class="col-md-3 text-center" style="padding-top: 3%; padding-bottom: 3%; overflow-y: auto;">
        		<h3 id="title-lft" class="folder-title">หมวดหมู่สินค้า</h3>
        		<div id="brand-tools" class="row justify-content-center" style="margin-top: -5%;">
        			<div id="brand-add" class="col-2"><h4><i id="i-brand-add" class="fas fa-plus-circle" onclick="addbrand();"></i></h4></div>
        			<div id="brand-remove" class="col-2"><h4><i id="i-brand-trash" class="fas fa-trash" onclick="removebrand('fa-trash');"></i></h4></div>
        			<div id="brand-edit" class="col-2"><h4><i id="i-brand-edit" class="fas fa-pen" onclick="editbrand('fa-pen');"></i></h4></div>
        		</div>       		
        		
        	</div>
			<div id="col-prod" class="col-md-9" style="overflow-y: auto;">
				<div id="append-title">				
					<h5 class="prod-title"><i id="i-back" onclick="page_back();" class="fas fa-angle-left"></i> ชื่อสินค้า <span> < ชื่อสินค้า 2</span> <span> < ชื่อสินค้า 3</span><i id="i-prod-add" class="fas fa-plus-circle" style="margin-left: 75%; margin-right: 1.5%;" onclick="addprod()"></i><i class="fas fa-trash" style="margin-right: 1.5%;" onclick="removeprod();"></i><i class="fas fa-pen" onclick="editprod();"></i></h5>
				</div>				
				<div id="append-prod">						
					<!-- append prod or folder -->
				</div>
        	</div>
      	</div>
      	<div class="row justify-content-end">
      		<div class="col-2 text-center">
      			<button id="btn-next" class="btn btn-success" onclick="next()">เลือกสินค้า(0)</button>
      		</div>
      	</div>
	</div>
</body>
</html>