<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>รายงานสินค้าออก</title>

    <!-- Bootstrap Import -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ"
        crossorigin="anonymous">

    <!-- QRcode -->
    <script type="text/javascript" src="js/qrcode.min.js"></script>
    <script type="text/javascript" src="js/jQuery.print.js"></script>

    <!-- Super cool dialog-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>

    <!-- Loading -->
    <link rel="stylesheet" href="css/easy-loading.css">
    <script src="js/easy-loading.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet">
    <!-- Main -->
    <link href="css/untitled.css" rel="stylesheet">
    <style>
    body{color: #666;}
    a{ color: #999;}
    a:hover{color: #666;}
    .active{color: #666;}
    .ipt-odd, .ipt-even{
      padding-top: 1%; padding-bottom: 1%; color: #fff; margin-bottom: 1%; cursor: pointer;
    }
    .ipt-odd{
      background-color: #999;
    }
    .ipt-even{
      background-color: #858585;
    }
    h5{
      letter-spacing: 2px;
    }
    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    div[id^="detail"]{
        margin-bottom: 0.8em;
    }
    .items{
        font-size: 120%;
    }
    div[id^="item-"]{
        margin-top: 0.5em;
    }
  </style>
  <script>
    var start = start_s = 0;
    var bool = bool_s = false;
    $(document).ready(function(){
      if(!localStorage.user_id){
				window.location = 'web_login.html';
			}
      get_export();
     
      window.onscroll = function(ev) {
          if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {            
            if(!$("#myUL").prop('hidden')){              
              if(bool){
                return 0;
              }
              get_export();           
            }else if(!$("#myS").prop('hidden')){
              if(bool_s){
                return 0;
              }
              get_export_s();
            }
          }
      };    
      // $(window).scroll(function() {
      //   if($(window).scrollTop() + $(window).height() == $(document).height()) {
      //     if(!$("#myUL").prop('hidden')){
      //       if(bool){
      //         return 0;
      //       }
      //       get_export();           
      //     }else if(!$("#myS").prop('hidden')){
      //       if(bool_s){
      //         return 0;
      //       }
      //       get_export_s();
      //     }
      //   }
      // });
    });
    
    $(document).keydown(function(objEvent) {
      if (objEvent.keyCode == 13) {  //enter pressed
        objEvent.preventDefault();           
        search();        
      }         
    })
   
    function get_export(){
      $.ajax({
        type: "POST",
        url:"php/get_export.php",
        data: {'start': start},       
        beforeSend: function(){
          EasyLoading.show({                           
						text: "กำลังโหลด"
					});
        },                       
        success: function(data){ 
          EasyLoading.hide();
          var obj = jQuery.parseJSON(data);
          if(obj[0] == "last"){
            bool = true
          }                        
          $.each(obj, function(i, field){
            if(i > 0){
              var txt = field.date_time.split(" ");
              var txt2 = txt[0].split("-");
              var date = txt2[2] + "/" + txt2[1] + "/" + txt2[0].substr(2);
              $('#myUL').append('<li id="ipt-'+field.stock_out_id+'">' +
              '<div class="row justify-content-center ipt-even" data-toggle="collapse" href="#detail-'+field.stock_out_id+'" role="button" aria-expanded="false" aria-controls="detail-'+field.stock_out_id+'" onclick="appendCollapse('+field.stock_out_id+');">'+
                  '<div class="col-4 text-center"><h5>'+field.stock_out_number+'</h5></div>' +
                  '<div class="col-3 text-center"><h5>'+date+'</h5></div>' +
                  '<div class="col-4 text-center"><h5>'+field.ware_name+'</h5></div>' +
              '</div>' +
            '</li>');   
            }                                               
          });                                          
        }               
      });
      start += 30;
    }   

    var val;
    function search(){
      if($('#input-search').val() == ""){
        return 0;
      }     
      val = $('#input-search').val()
      start_s = 0;
      bool_s = false;
      $("#myS").prop('hidden', false);
      $("#myUL").prop('hidden', true);     
      $("#myS").empty();
      get_export_s();
    }

    function get_export_s(){
      $.ajax({
        type: "POST",
        url:"php/get_export.php",
        data: {'start': start_s, 'value' : val},
        beforeSend: function(){
          EasyLoading.show({                           
						text: "กำลังโหลด"
					});
        },                       
        success: function(data){ 
          EasyLoading.hide();
          var obj = jQuery.parseJSON(data);
          if(obj[0] == "last"){
            bool_s = true
          }                        
          $.each(obj, function(i, field){
            if(i > 0){
              var txt = field.date_time.split(" ");
              var txt2 = txt[0].split("-");
              var date = txt2[2] + "/" + txt2[1] + "/" + txt2[0].substr(2);
              $('#myS').append('<li id="ipts-'+field.stock_out_id+'">' +
              '<div class="row justify-content-center ipt-even" data-toggle="collapse" href="#details-'+field.stock_out_id+'" role="button" aria-expanded="false" aria-controls="details-'+field.stock_out_id+'" onclick="appendCollapses('+field.stock_out_id+');">'+
                  '<div class="col-4 text-center"><h5>'+field.stock_out_number+'</h5></div>' +
                  '<div class="col-3 text-center"><h5>'+date+'</h5></div>' +
                  '<div class="col-4 text-center"><h5>'+field.ware_name+'</h5></div>' +
              '</div>' +
            '</li>');    
            }                                                
          });                                         
        }               
      });
      start_s += 30;
    }
    
    var dt,username,warename,stock_num
    function appendCollapse(index){
        if($("#detail-"+index).length){
            //
        }else{    
          arr_data = [];
          var text = ""
          $.ajax({
            type: "POST",
            url:"php/get_export_info.php",    
            data:{'exp_id' : index},
            async:false,                          
            beforeSend: function(){
              EasyLoading.show({                           
                text: "กำลังโหลด"
              });
            },             
            success: function(data){  
              EasyLoading.hide();
              var obj = jQuery.parseJSON(data); 
              text = text + '<div class="collapse" id="detail-'+index+'">'+
                '<div class="card card-body">'+
                  '<div class="row justify-content-center">'+
                      '<h3 style="text-decoration: underline;">รายการ</h3>'+
                  '</div>'             
              $.each(obj, function(i, field){
                cost = ""
                if(localStorage.user_role != "พนักงาน"){
                  cost = field.stock_out_cost
                } 
                text = text + '<div id="item-'+field.item_id+'" class="row justify-content-center">'+
                  '<div class="col-1 text-center items">'+field.amount+'</div>'+
                  '<div class="col-7 text-center items">'+field.prod_name+'</div>'+
                  '<div class="col-2 text-center items">'+cost+'</div>'+
                  '<div class="col-2 text-center items">'+field.amount*field.stock_out_cost+'</div>'+
                '</div>'

                item = {}
                item ["prod_id"] =  field.prod_id
                item ["qr"] =  field.prod_code
                item ["name"] =  field.prod_name
                item ["amt"] =  field.amount
                item ["cost"] =  field.stock_out_cost
                stock_num = field.stock_out_number
                dt = field.date_time
                username = field.user_name
                warename = field.ware_name
                arr_data.push(item);
              });
              text = text + '<hr style="width: 50%; margin: auto; margin-top: 1em;">'+
                  '<div class="row" style="margin-top: 1em;">'+
                    '<div class="col-4 text-right"><h4>ผู้ทำรายการ</h4></div>'+
                      '<div class="col-4 text-right"><h4>'+obj[0].user_name+'</h4></div>'+ 
                  '</div>'+
                  '<div class="row justify-content-center" style="margin-top: 1em;">'+
                  '<div class="col-4 text-center">'+                   
                    '<button onclick="print.apply(this,arr_data)" class="btn btn-lg btn-warning" style="color: white;">พิมพ์รายการ  <i class="fas fa-print"></i></button>'+
                '</div>'+        
                '</div>'+  
                  '</div>'+
                '</div>';                   
            }               
          });

          $("#ipt-"+index).append(text);
        }
        $('html, body').animate({
              scrollTop: $("#ipt-"+index).offset().top
          }, 1100);
    }


    function appendCollapses(index){
        if($("#details-"+index).length){
            //
        }else{
          arr_data = [];
          var text = ""
          $.ajax({
            type: "POST",
            url:"php/get_export_info.php",    
            data:{'exp_id' : index},
            async:false,                          
            beforeSend: function(){
              EasyLoading.show({                           
                text: "กำลังโหลด"
              });
            },             
            success: function(data){  
              EasyLoading.hide();
              var obj = jQuery.parseJSON(data); 
              text = text + '<div class="collapse" id="details-'+index+'">'+
                '<div class="card card-body">'+
                  '<div class="row justify-content-center">'+
                      '<h3 style="text-decoration: underline;">รายการ</h3>'+
                  '</div>'             
              $.each(obj, function(i, field){
                cost = ""
                if(localStorage.user_role != "พนักงาน"){
                  cost = field.stock_out_cost
                }
                text = text + '<div id="item-'+field.item_id+'"" class="row justify-content-center">'+
                  '<div class="col-1 text-center items">'+field.amount+'</div>'+
                  '<div class="col-7 text-center items">'+field.prod_name+'</div>'+
                  '<div class="col-2 text-center items">'+cost+'</div>'+
                  '<div class="col-2 text-center items">'+field.amount*field.stock_out_cost+'</div>'+
                '</div>'

                item = {}
                item ["prod_id"] =  field.prod_id
                item ["qr"] =  field.prod_code
                item ["name"] =  field.prod_name
                item ["amt"] =  field.amount
                item ["cost"] =  field.stock_out_cost
                dt = field.date_time
                username = field.user_name
                warename = field.ware_name
                arr_data.push(item);
              });
              text = text + '<hr style="width: 50%; margin: auto; margin-top: 1em;">'+
                  '<div class="row" style="margin-top: 1em;">'+
                    '<div class="col-4 text-right"><h4>ผู้ทำรายการ</h4></div>'+
                      '<div class="col-4 text-right"><h4>'+obj[0].user_name+'</h4></div>'+
                  '</div>'+ 
                  '<div class="row justify-content-center" style="margin-top: 1em;">'+
                  '<div class="col-4 text-center">'+                   
                    '<button onclick="print.apply(this,arr_data)" class="btn btn-lg btn-warning" style="color: white;">พิมพ์รายการ  <i class="fas fa-print"></i></button>'+
                '</div>'+        
                '</div>'+         
                '</div>'+
              '</div>';                   
            }               
          });

          $("#ipts-"+index).append(text);
        }
        $('html, body').animate({
              scrollTop: $("#ipts-"+index).offset().top
          }, 1100);
    }    

    function print(...arr_data){
      $('#show_qr').empty();     
			var text = "";		
			var total_amt = 0;		
			var text_id = ""
			var text_cost = ""
			var text_amt = ""         
      
			$.each(arr_data, function(i, field){				
        text_id += "," + arr_data[i].prod_id
				text_cost += "," + arr_data[i].cost
				text_amt += "," + arr_data[i].amt
				text = text + "<div class='row items'>" +                                
                        "<div class='col-8 text-center'>"+arr_data[i].name+"</div>" +
                        "<div class='col-4 no text-left'>"+arr_data[i].amt+"</div>" +
                      "</div>"
				total_amt += parseInt(arr_data[i].amt)			                                                          
			});     
			$('#show_qr').append('<div style="display: inline-block;">'+
									'<div class="qr-l" id="qrcode"></div>' +									
								'</div>');
			var text_qr = "[transfer]" + text_id.substring(1) + "|" + text_cost.substring(1) + "|" + text_amt.substring(1) + "|" + "-"
			console.log(text_qr)
			qrcode = new QRCode("qrcode",{width: 230, height: 230});
			qrcode.makeCode(text_qr);	

      var datetime = dt.split(" ")
      var time = datetime[1];
      var d = datetime[0].split("-");
      var date = d[2] + "/" + d[1] + "/" + d[0];
      var dat = " ____________________"
			var WinPrint  = window.open();
      window.setTimeout(function() {
      var ele =  document.getElementById('show_qr').innerHTML;
      WinPrint.document.write("<html><head><meta charset='utf-8'><link href='https://fonts.googleapis.com/css?family=Maitree' rel='stylesheet'><link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css' integrity='sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T' crossorigin='anonymous'>");
			WinPrint.document.write("<style>@page {size: auto; margin: 0mm;} body{line-height: 1.5; font-size: 0.9em; } .title{margin-bottom: 0.1em;} .line{text-decoration: underline;} .price, .no{letter-spacing: -0.05em;} .items{margin-bottom: 5px;}</style></head><body>" +
      "<div style='width: 7cm;'>"+
            "<div class='col-12 text-center'>DD MOTOR SPORT</div>"+
            "<div class='col-12 text-center'>B-24, B-28 อาคารศรีวรจักร ถ.หลวงป้อมปราบศัตรูพ่าย</div>"+
            "<div class='col-12 text-center'>โทร. 02-2265280 , 02-2222437</div>"+
            "<div class='col-12 text-center line' style='margin-top: 0.5em; margin-bottom: 0.5em;'>ใบรายการสินค้าออกโกดัง</div>"+						
              "<div class='row justify-content-center title'>" +
              "<div class='col-4 text-right'>เลขที่ : </div>" +
              "<div class='col-6 text-center'>"+stock_num+"</div>" +
              "</div>" +
              "<div class='row justify-content-center title'>" +
              "<div class='col-4 text-right'>โกดัง : </div>" +
              "<div class='col-6 text-center'>"+warename+"</div>" +
              "</div>" +
              "<div class='row justify-content-center title'>" +
              "<div class='col-4 text-right'>พนักงาน : </div>" +
              "<div class='col-6 text-center'>"+username+"</div>" +
              "</div>" +
              "<div class='row justify-content-center title'>" +
              "<div class='col-4 text-right'>วันที่ : </div>" +
              "<div class='col-3 text-right'>"+date+"  </div>" +
              "<div class='col-3'>"+time+"</div>" +
              "</div>" +								
                        
              "<hr style='width: 90%; border-top: 1px dashed; border-bottom: none; margin-top: 5px;'>"+
              "<div class='row justify-content-center' style='margin-bottom: 5px;'>" +								
              "<div class='col-8 text-center line'>รายการ</div>" +
              "<div class='col-4 text-left line'>จำนวน</div>" +
            "</div>"+
            text+
            "<hr style='width: 90%; border-top: 1px; border-top: 1px dashed; border-bottom: none; margin-top: 0;'>"+
            "<div class='row justify-content-center title'>"+
              "<div class='col-4 text-right'>รวม : </div>" +
              "<div class='col-6 text-center'>"+total_amt+"</div>"+
            "</div>"+
            "<div class='col-12 text-center'>ผู้นำสินค้าออก : "+dat+"</div>"+
            "<div class='col-12 text-center'>ผู้เช็คสินค้า : "+dat+"</div>"+
            "<div class='col-12 text-center'>ผู้นำสินค้าเข้า : "+dat+"</div>"+
            "<div class='col-12 text-center' style='margin-top: 10px'>"+
              ele+
            "</div>"+
            "</div>");
      WinPrint.document.write('</body></html>');
      WinPrint.document.close();
      WinPrint.focus();
      setTimeout(function() {
      WinPrint.print();
      WinPrint.close();
      }, 250);
    }, 500);
    }

    function logout(){
			localStorage.clear();
		}

  </script>
</head>

<body>
    <div class="container-fullwidth justify-content-center">
        <nav class="navbar navbar-expand-md navbar-dark">
            <div class="collapse navbar-collapse justify-content-md-center" id="navbarCollapse">
                <h3 id="nav-title">รายงานสินค้าออกโกดัง</h3>
            </div>
        </nav>
        <div class="container">
            <div class="row" style="margin-top: 2px;">
                <div class="col-12 text-center">
                    <a href="web_sale.html" class="mgr-20">ขายสินค้า</a>
                    <a href="web_import.html" class="mgr-20">นำสินค้าเข้า</a>
                    <a href="web_stock.html" class="mgr-20">เช็คสต๊อก</a>
                    <a href="web_export.html" class="mgr-20">สินค้าออกโกดัง</a>                   
                    <a href="web_select.html" class="mgr-20 active">รายการย้อนหลัง</a>
                    <a href="web_qrprint.html" class="mgr-20">พิมพ์คิวอาร์</a>
                    <a href="" class="mgr-20" onclick="logout()">ออกจากระบบ</a>
                </div>
            </div>
        </div><br><br>
        <div class="container-fullwidth">
            <div class="input-group row justify-content-center" style="margin-bottom: 4%; margin-left: 0.5%">
                <input id="input-search" type="text" class="form-control-lg text-center"
                    placeholder="ค้าหา เลขที่ออก / สินค้า" style="width: 60%;">
                <button  class="btn btn-outline-secondary" type="button" style="margin-left: 10px;" hidden>
                    <i class="fa fa-calendar-alt"></i>
                </button>
            </div>
        </div>
        <div class="container-fullwidth">
            <div class="row justify-content-center">
                <div class="col-4 text-center">
                    <h4>เลขที่ออก</h4>
                </div>
                <div class="col-3 text-center">
                    <h4>วันที่</h4>
                </div>
                <div class="col-3 text-center">
                    <h4>โกดัง</h4>
                </div>
            </div>
        </div>
        <hr style="width: 75%; margin-top: 0;"> <br>
        <div id="ctn-append" class="container-fullwidth">
            <ul id="myUL">
                <!-- <li>
                    <div class="row justify-content-center ipt-odd">
                        <div class="col-4 text-center">
                            <h5>IMP18-00054</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>03/10/18</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>โกดัง A</h5>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="row justify-content-center ipt-even">
                        <div class="col-4 text-center">
                            <h5>IMP19-00054</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>03/10/18</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>โกดัง B</h5>
                        </div>
                    </div>
                </li> -->
            </ul>
            <ul id="myS" hidden>
            </ul>
        </div>
        <div id="show_qr" hidden>

        </div>	


        <!--- // New ctn-append using with appendCollapse() function ...
        
        <div id="ctn-append" class="container-fullwidth">
          <ul id="myUL">
            <li id="ipt-1">
              <div class="row justify-content-center ipt-odd" data-toggle="collapse" href="#detail-1" role="button" aria-expanded="false" aria-controls="detail-1" onclick="appendCollapse(1);">
                  <div class="col-4 text-center"><h5>S18-00329</h5></div>
                  <div class="col-3 text-center"><h5>03/10/18</h5></div>
                  <div class="col-4 text-center"><h5>Phoenix</h5></div>
              </div>
            </li>
            <li id="ipt-2">
              <div class="row justify-content-center ipt-even" data-toggle="collapse" href="#detail-2" role="button" aria-expanded="false" aria-controls="detail-2" onclick="appendCollapse(2);">
                  <div class="col-4 text-center"><h5>S18-00329</h5></div>
                  <div class="col-3 text-center"><h5>03/10/18</h5></div>
                  <div class="col-4 text-center"><h5>Phoenix</h5></div>
              </div>
            </li>
          </ul>
        </div>

        --->
    </div>
</body>

</html>