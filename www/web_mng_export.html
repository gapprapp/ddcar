<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>รายงานสินค้าออก</title>

    <!-- Bootstrap Import -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ"
        crossorigin="anonymous">

    <!-- QRcode -->
    <script type="text/javascript" src="js/qrcode.min.js"></script>
    <script type="text/javascript" src="js/jQuery.print.js"></script>

    <!-- Super cool dialog-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>

    <!-- Loading -->
    <link rel="stylesheet" href="css/easy-loading.css">
    <script src="js/easy-loading.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet">
    <!-- Main -->
    <link href="css/untitled.css" rel="stylesheet">
    <style>
    body{color: #666;}
    a{ color: #999;}
    a:hover{color: #666;}
    .active{color: #666;}
    .ipt-odd, .ipt-even{
      padding-top: 1%; padding-bottom: 1%; color: #fff; margin-bottom: 1%; cursor: pointer;
    }
    .ipt-odd{
      background-color: #999;
    }
    .ipt-even{
      background-color: #858585;
    }
    h5{
      letter-spacing: 2px;
    }
    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
    div[id^="detail"]{
        margin-bottom: 0.8em;
    }
    .items{
        font-size: 120%;
    }
    div[id^="item-"]{
        margin-top: 0.5em;
    }
  </style>
  <script>
    var start = start_s = 0;
    var bool = bool_s = false;
    $(document).ready(function(){
      get_export();

      $(window).scroll(function() {
        if($(window).scrollTop() + $(window).height() == $(document).height()) {
          if(!$("#myUL").prop('hidden')){
            if(bool){
              return 0;
            }
            get_export();           
          }else if(!$("#myS").prop('hidden')){
            if(bool_s){
              return 0;
            }
            get_export_s();
          }
        }
      });
    });
    
    $(document).keydown(function(objEvent) {
      if (objEvent.keyCode == 13) {  //enter pressed
        objEvent.preventDefault();           
        search();        
      }         
    })
   
    function get_export(){
      $.ajax({
        type: "POST",
        url:"php/get_export.php",
        data: {'start': start},       
        beforeSend: function(){
          EasyLoading.show({                           
						text: "กำลังโหลด"
					});
        },                       
        success: function(data){ 
          EasyLoading.hide();
          var obj = jQuery.parseJSON(data);
          if(obj[0] == "last"){
            bool = true
          }                        
          $.each(obj, function(i, field){
            if(i > 0){
              var txt = field.date_time.split(" ");
              var txt2 = txt[0].split("-");
              var date = txt2[2] + "/" + txt2[1] + "/" + txt2[0].substr(2);
              $('#myUL').append('<li id="ipt-'+field.stock_out_id+'">' +
              '<div class="row justify-content-center ipt-even" data-toggle="collapse" href="#detail-'+field.stock_out_id+'" role="button" aria-expanded="false" aria-controls="detail-'+field.stock_out_id+'" onclick="appendCollapse('+field.stock_out_id+');">'+
                  '<div class="col-4 text-center"><h5>'+field.stock_out_number+'</h5></div>' +
                  '<div class="col-3 text-center"><h5>'+date+'</h5></div>' +
                  '<div class="col-4 text-center"><h5>'+field.ware_name+'</h5></div>' +
              '</div>' +
            '</li>');   
            }                                               
          });                                          
        }               
      });
      start += 30;
    }   

    var val;
    function search(){
      if($('#input-search').val() == ""){
        return 0;
      }     
      val = $('#input-search').val()
      start_s = 0;
      bool_s = false;
      $("#myS").prop('hidden', false);
      $("#myUL").prop('hidden', true);     
      $("#myS").empty();
      get_export_s();
    }

    function get_export_s(){
      $.ajax({
        type: "POST",
        url:"php/get_export.php",
        data: {'start': start_s, 'value' : val},
        beforeSend: function(){
          EasyLoading.show({                           
						text: "กำลังโหลด"
					});
        },                       
        success: function(data){ 
          EasyLoading.hide();
          var obj = jQuery.parseJSON(data);
          if(obj[0] == "last"){
            bool_s = true
          }                        
          $.each(obj, function(i, field){
            if(i > 0){
              var txt = field.date_time.split(" ");
              var txt2 = txt[0].split("-");
              var date = txt2[2] + "/" + txt2[1] + "/" + txt2[0].substr(2);
              $('#myS').append('<li id="ipts-'+field.stock_out_id+'">' +
              '<div class="row justify-content-center ipt-even" data-toggle="collapse" href="#details-'+field.stock_out_id+'" role="button" aria-expanded="false" aria-controls="details-'+field.stock_out_id+'" onclick="appendCollapses('+field.stock_out_id+');">'+
                  '<div class="col-4 text-center"><h5>'+field.stock_out_number+'</h5></div>' +
                  '<div class="col-3 text-center"><h5>'+date+'</h5></div>' +
                  '<div class="col-4 text-center"><h5>'+field.ware_name+'</h5></div>' +
              '</div>' +
            '</li>');    
            }                                                
          });                                         
        }               
      });
      start_s += 30;
    }
  
    function appendCollapse(index){
        if($("#detail-"+index).length){
            //
        }else{          
          var text = ""
          $.ajax({
            type: "POST",
            url:"php/get_export_info.php",    
            data:{'exp_id' : index},
            async:false,                          
            beforeSend: function(){
              EasyLoading.show({                           
                text: "กำลังโหลด"
              });
            },             
            success: function(data){  
              EasyLoading.hide();
              var obj = jQuery.parseJSON(data); 
              text = text + '<div class="collapse" id="detail-'+index+'">'+
                '<div class="card card-body">'+
                  '<div class="row justify-content-center">'+
                      '<h3 style="text-decoration: underline;">รายการ</h3>'+
                  '</div>'             
              $.each(obj, function(i, field){
                text = text + '<div id="item-'+field.item_id+'" class="row justify-content-center">'+
                  '<div class="col-1 text-center items">'+field.amount+'</div>'+
                  '<div class="col-7 text-center items">'+field.prod_name+'</div>'+
                  '<div class="col-2 text-center items">'+field.stock_out_cost+'</div>'+
                  '<div class="col-2 text-center items">'+field.amount*field.stock_out_cost+'</div>'+
                '</div>'
              });
              text = text + '<hr style="width: 50%; margin: auto; margin-top: 1em;">'+
                  '<div class="row" style="margin-top: 1em;">'+
                    '<div class="col-4 text-right"><h4>ผู้ทำรายการ</h4></div>'+
                      '<div class="col-4 text-right"><h4>'+obj[0].user_name+'</h4></div>'+ 
                  '</div>'+  
                  '</div>'+
                '</div>';                   
            }               
          });

          $("#ipt-"+index).append(text);
        }
        $('html, body').animate({
              scrollTop: $("#ipt-"+index).offset().top
          }, 1100);
    }

    function appendCollapses(index){
        if($("#details-"+index).length){
            //
        }else{          
          var text = ""
          $.ajax({
            type: "POST",
            url:"php/get_export_info.php",    
            data:{'exp_id' : index},
            async:false,                          
            beforeSend: function(){
              EasyLoading.show({                           
                text: "กำลังโหลด"
              });
            },             
            success: function(data){  
              EasyLoading.hide();
              var obj = jQuery.parseJSON(data); 
              text = text + '<div class="collapse" id="details-'+index+'">'+
                '<div class="card card-body">'+
                  '<div class="row justify-content-center">'+
                      '<h3 style="text-decoration: underline;">รายการ</h3>'+
                  '</div>'             
              $.each(obj, function(i, field){               
                text = text + '<div id="item-'+field.item_id+'"" class="row justify-content-center">'+
                  '<div class="col-1 text-center items">'+field.amount+'</div>'+
                  '<div class="col-7 text-center items">'+field.prod_name+'</div>'+
                  '<div class="col-2 text-center items">'+field.stock_out_cost+'</div>'+
                  '<div class="col-2 text-center items">'+field.amount*field.stock_out_cost+'</div>'+
                '</div>'
              });
              text = text + '<hr style="width: 50%; margin: auto; margin-top: 1em;">'+
                  '<div class="row" style="margin-top: 1em;">'+
                    '<div class="col-4 text-right"><h4>ผู้ทำรายการ</h4></div>'+
                      '<div class="col-4 text-right"><h4>'+obj[0].user_name+'</h4></div>'+
                  '</div>'+          
                '</div>'+
              '</div>';                   
            }               
          });

          $("#ipts-"+index).append(text);
        }
        $('html, body').animate({
              scrollTop: $("#ipts-"+index).offset().top
          }, 1100);
    }    

    function logout(){
			localStorage.clear();
		}

  </script>
</head>

<body>
    <div class="container-fullwidth justify-content-center">
        <nav class="navbar navbar-expand-md navbar-dark">
            <div class="collapse navbar-collapse justify-content-md-center" id="navbarCollapse">
                <h3 id="nav-title">รายงานสินค้าออกโกดัง</h3>
            </div>
        </nav>
        <div class="container">
            <div class="row" style="margin-top: 2px;">
                <div class="col-12 text-center">
                    <a href="web_sale.html" class="mgr-20">ขายสินค้า</a>
                    <a href="web_import.html" class="mgr-20">นำสินค้าเข้า</a>
                    <a href="web_stock.html" class="mgr-20">เช็คสต๊อก</a>
                    <a href="web_export.html" class="mgr-20">สินค้าออกโกดัง</a>                   
                    <a href="web_select.html" class="mgr-20 active">รายการย้อนหลัง</a>
                    <a href="web_qrprint.html" class="mgr-20">พิมพ์คิวอาร์</a>
                    <a href="" class="mgr-20" onclick="logout()">ออกจากระบบ</a>
                </div>
            </div>
        </div><br><br>
        <div class="container-fullwidth">
            <div class="input-group row justify-content-center" style="margin-bottom: 4%; margin-left: 0.5%">
                <input id="input-search" type="text" class="form-control-lg text-center"
                    placeholder="ค้าหา เลขที่ออก / สินค้า" style="width: 60%;">
                <button  class="btn btn-outline-secondary" type="button" style="margin-left: 10px;" hidden>
                    <i class="fa fa-calendar-alt"></i>
                </button>
            </div>
        </div>
        <div class="container-fullwidth">
            <div class="row justify-content-center">
                <div class="col-4 text-center">
                    <h4>เลขที่ออก</h4>
                </div>
                <div class="col-3 text-center">
                    <h4>วันที่</h4>
                </div>
                <div class="col-3 text-center">
                    <h4>โกดัง</h4>
                </div>
            </div>
        </div>
        <hr style="width: 75%; margin-top: 0;"> <br>
        <div id="ctn-append" class="container-fullwidth">
            <ul id="myUL">
                <!-- <li>
                    <div class="row justify-content-center ipt-odd">
                        <div class="col-4 text-center">
                            <h5>IMP18-00054</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>03/10/18</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>โกดัง A</h5>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="row justify-content-center ipt-even">
                        <div class="col-4 text-center">
                            <h5>IMP19-00054</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>03/10/18</h5>
                        </div>
                        <div class="col-3 text-center">
                            <h5>โกดัง B</h5>
                        </div>
                    </div>
                </li> -->
            </ul>
            <ul id="myS" hidden>
            </ul>
        </div>
        <div id="show_qr" hidden>

        </div>	


        <!--- // New ctn-append using with appendCollapse() function ...
        
        <div id="ctn-append" class="container-fullwidth">
          <ul id="myUL">
            <li id="ipt-1">
              <div class="row justify-content-center ipt-odd" data-toggle="collapse" href="#detail-1" role="button" aria-expanded="false" aria-controls="detail-1" onclick="appendCollapse(1);">
                  <div class="col-4 text-center"><h5>S18-00329</h5></div>
                  <div class="col-3 text-center"><h5>03/10/18</h5></div>
                  <div class="col-4 text-center"><h5>Phoenix</h5></div>
              </div>
            </li>
            <li id="ipt-2">
              <div class="row justify-content-center ipt-even" data-toggle="collapse" href="#detail-2" role="button" aria-expanded="false" aria-controls="detail-2" onclick="appendCollapse(2);">
                  <div class="col-4 text-center"><h5>S18-00329</h5></div>
                  <div class="col-3 text-center"><h5>03/10/18</h5></div>
                  <div class="col-4 text-center"><h5>Phoenix</h5></div>
              </div>
            </li>
          </ul>
        </div>

        --->
    </div>
</body>

</html>