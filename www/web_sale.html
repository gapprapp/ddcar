<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>ขายสินค้า</title>

  <!-- Bootstrap Import -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.6/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.1/css/all.css" integrity="sha384-O8whS3fhG2OnA5Kas0Y9l3cfpmYjapjI0E4theH4iuMD+pLhbf6JI0jIMfYcK3yZ" crossorigin="anonymous">

  <!-- Super cool dialog-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.0/jquery-confirm.min.js"></script>
	
	<!-- Easy-autocomplete -->
	<script src="js/jquery.easy-autocomplete.js"></script>
	<link rel="stylesheet" href="css/easy-autocomplete.min.css">
	<link rel="stylesheet" href="css/easy-autocomplete.themes.min.css">
	
	<!-- Loading -->
	<link rel="stylesheet" href="css/easy-loading.css">
	<script src="js/easy-loading.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css?family=Prompt" rel="stylesheet">
  <!-- Main -->
  <link href="css/untitled.css" rel="stylesheet">

  <style>
  	img{
		height: 200px;
		width: 200px;
	}
  </style>

  <script>
		var prod_id,img,cus_id,cus_type,old_price,cus_addr,cus_tel,min;
		$(document).ready(function () {
			if(!localStorage.user_id){
				window.location = 'web_login.html';
			}
			get_header();
			setTimeout(function() {$("#cus").focus();}, 100);

			if(localStorage.ware_id_s){
                $('#btn-b').text(localStorage.ware_name_s);
				b_id = localStorage.ware_id_s;
				type = localStorage.type;
            }	

			if(localStorage.cus_id){
				cus_id = localStorage.cus_id;
				cus_type = localStorage.cus_type;
				cus_addr = localStorage.cus_addr;
				cus_tel = localStorage.cus_tel;
				$("#cus").val(localStorage.cus_name);				
			}      

			if(localStorage.arr_sale){     
				var retrievedObject = localStorage.getItem('arr_sale');
				arr_data = JSON.parse(retrievedObject);          
				count = arr_data[arr_data.length-1].count + 1;             
				add_previous();
     		 }      

			if(localStorage.arr_prod_s){
				$("#btn-folder").attr('disabled',true);
				$("#btn-def").attr('disabled',true);
				$("#name").attr('readonly',true);
				var retrievedObject = localStorage.getItem('arr_prod_s');
				var arr_data2 = JSON.parse(retrievedObject); 
				prod_id = arr_data2[0].prod_id;            
				get_sale(prod_id);
				setTimeout(function() {$("#amount").focus();}, 100);
      		}    

			var options = {
				url: function(phrase) {				
					return "php/search_sale.php?cus_id="+cus_id+"&ware_id="+b_id+"&type="+type;
				},
				getValue: function(element) {
					//console.log(element);
					return element.prod_name;
				},
				ajaxSettings: {
					method: "POST",
					data: {}
				},
				preparePostData: function(data) {     
					if($("#cus").val() == ""){
						$.alert({
						icon: 'fa fa-warning',
						title: 'เตือน',
						content: "กรุณาใส่ชื่อลูกค้าก่อนทำรายการ"
						});
						$("#cus").focus();
						$("#name").val("");
						return 0;
         			}else if($('#btn-b').text() == "เลือกโกดัง/หน้าร้าน"){
						$.confirm({
							title: 'พบข้อผิดพลาด',
							content: 'กรุณาเลือกโกดัง/หน้าร้านก่อนทำรายการ',
							backgroundDismiss: true,
							buttons: {
								formSubmit: {
									text: 'ตกลง',
									btnClass: 'btn-regis',
									action: function () {
									}
								}
							}
						});  
						$("#name").val("");
						return 0;
					}else{
						prod_id = 0;
						data.phrase = $("#name").val();
						return data;
          			}
				},
				minCharNumber: 3,
				list: {
						maxNumberOfElements: 1000,

						showAnimation: {
								type: "slide",
								time: 100
						},
						hideAnimation: {
								type: "slide",
								time: 100
						},
						onChooseEvent: function() {
							for(var b = 0; b < count; b++){
								if($("#name").val() == $("#name-"+b).val()){
									$.alert({
										icon: 'fa fa-warning',
										title: 'เตือน',
										content: "มีการเพิ่มสินค้า " + $("#name").val() + "กรุณาแก้ไขที่จำนวนของสินค้าที่ได้เพิ่มแล้ว",
									});
									set_default();
									return 0;                
								}
							}
							var barcode = $("#name").getSelectedItemData().prod_code;						
							prod_id = $("#name").getSelectedItemData().prod_id;
							img = $("#name").getSelectedItemData().img;	

							if($("#name").getSelectedItemData()[9]){
									$('#price').val($("#name").getSelectedItemData()[9]);  
							}else{                                
								if(cus_type == "ขายปลีก"){
										$('#price').val($("#name").getSelectedItemData().prod_price);  
								}else{
										$('#price').val($("#name").getSelectedItemData().prod_pricesend);  
								}                                
							}
							old_price = $('#price').val();
							min = $("#name").getSelectedItemData().min_amount;        
							$('#barcode').val(barcode);							
							$('#amount').val("1");		
							$('#total').val(old_price);
							if(min == 0){
								$.confirm({
									title: 'เตือน',
									content: 'สินค้าไม่มีใน' + $('#btn-b').text(),
									backgroundDismiss: true,
									buttons: {
										formSubmit: {
										text: 'ตกลง',
										btnClass: 'btn-regis',
										action: function () {
										}
										}
									}
								});  
								set_default();
							}	
						}
				},
				requestDelay: 300,
				theme: "blue-light",
				};
			$("#name").easyAutocomplete(options);	

			var options_cus = {

				url: function(phrase) {
					return "php/search_cus.php";
				},

				getValue: function(element) {
					//console.log(element);
					return element.cus_name;
				},

				ajaxSettings: {
					method: "POST",
					data: {}
				},

				preparePostData: function(data) {
					cus_id = -1;
					data.phrase = $("#cus").val();
					return data;
				},
				minCharNumber: 2,
				list: {
						maxNumberOfElements: 100,

						showAnimation: {
								type: "slide",
								time: 100
						},
						hideAnimation: {
								type: "slide",
								time: 100
						},
						onSelectItemEvent: function() {                
							cus_id = $("#cus").getSelectedItemData().cus_id;						
							cus_addr = $("#cus").getSelectedItemData().cus_addr;
							cus_type = $("#cus").getSelectedItemData().cus_type;
							localStorage.cus_name = $("#cus").getSelectedItemData().cus_name;
              localStorage.cus_id = cus_id;
							localStorage.cus_type = cus_type;
							localStorage.cus_addr = cus_addr;
							if(cus_addr == ""){
								cus_addr = "-";
								localStorage.cus_addr = cus_addr;
							}
							cus_tel = $("#cus").getSelectedItemData().cus_tel;
							localStorage.cus_tel = cus_tel;
							if(cus_tel == ""){
								cus_tel = "-";
								localStorage.cus_tel = cus_tel;
							}
							//console.log(cus_addr + cus_tel);
						},
						onChooseEvent: function() {                
							cus_id = $("#cus").getSelectedItemData().cus_id;						
							cus_addr = $("#cus").getSelectedItemData().cus_addr;
							cus_type = $("#cus").getSelectedItemData().cus_type;
							localStorage.cus_name = $("#cus").getSelectedItemData().cus_name;
              localStorage.cus_id = cus_id;
							localStorage.cus_type = cus_type;
							localStorage.cus_addr = cus_addr;
							if(cus_addr == ""){
								cus_addr = "-";
								localStorage.cus_addr = cus_addr;
							}
							cus_tel = $("#cus").getSelectedItemData().cus_tel;
							localStorage.cus_tel = cus_tel;
							if(cus_tel == ""){
								cus_tel = "-";
								localStorage.cus_tel = cus_tel;
							}						
						}
				},
				requestDelay: 300,  
				theme: "blue-light",          
				};
			$("#cus").easyAutocomplete(options_cus);
		});

		var bool = true;
		function get_sale(id){
			prod_id = id;					
			bool = true;
			for(var b = 0; b < arr_data.length; b++){
				if(prod_id == arr_data[b].prod_id){
					$.confirm({
						title: 'เตือน',
						content: 'มีการเพิ่มสินค้า ' + arr_data[b].name + ' กรุณาแก้ไขที่จำนวนของสินค้าที่ได้เพิ่มแล้ว',
						backgroundDismiss: true,
						buttons: {
							formSubmit: {
							text: 'ตกลง',
							btnClass: 'btn-regis',
							action: function () {
							}
							}
						}
					});  
					bool = false;                               
					break;           
				}
			}			
			if(bool){
					$.ajax({
						type: "POST",
						url:"php/get_sale.php",    
						data:{'prod_id' : id,'cus_id':cus_id,'ware_id':b_id,'type':type},
						//async: false,                       
						beforeSend: function(){
							EasyLoading.show({                           
								text: "กำลังโหลด"                            
							});
						},             
						success: function(data){  
							EasyLoading.hide();
							var obj = jQuery.parseJSON(data);                                                           
							$.each(obj, function(i, field){                           
								if(obj[i][9]){
									$('#price').val(obj[i][9]);  
								}else{                                
									if(cus_type == "ขายปลีก"){
										$('#price').val(obj[i].prod_price);  
									}else{
										$('#price').val(obj[i].prod_pricesend);  
									}                                
								}  
								$('#name').val(obj[i].prod_name);
								$('#barcode').val(obj[i].prod_code);                                                       
								img = obj[i].img;   
								old_price = $('#price').val();
								$('#amount').val("1");		
								$('#total').val(old_price);  
								min = obj[i].min_amount;
								if(min == 0){
									$.confirm({
										title: 'เตือน',
										content: 'สินค้าไม่มีใน' + $('#btn-b').text(),
										backgroundDismiss: true,
										buttons: {
											formSubmit: {
											text: 'ตกลง',
											btnClass: 'btn-regis',
											action: function () {
											}
											}
										}
									});  
									bool = false; 
									add();
								}	                                                                     
							});									                                          
						}               
					});     
			}else{
					add();
			}                   
		}
		
		$(document).keydown(function(objEvent) {
			if (objEvent.keyCode == 9) {  //tab pressed
				objEvent.preventDefault(); // stops its action         
			}
			if (objEvent.keyCode == 13) {  //enter pressed
				objEvent.preventDefault();
				var $this = $(objEvent.target);
				var i_enter = parseFloat($this.attr('data-index'));                      
				if(i_enter == 4){
					add();
				}else if(i_enter == 6){
					save2db();
				}else{          
					var temp = $('[data-index="' + (i_enter+1).toString() + '"]').val();
          $('[data-index="' + (i_enter+1).toString() + '"]').focus().val("").val(temp);
				}                       
			}  
			if (objEvent.keyCode == 113) {  //f2 pressed
        		add();
			}
			if (objEvent.keyCode == 115) {  //f4 pressed
				set_default();
			}
			if (objEvent.keyCode == 118) {  //f7 pressed
				selectfolder();         
			}   
			if (objEvent.keyCode == 119) {  //f8 pressed
				$('#btn_checkbill').click();          
            } 
            if (objEvent.keyCode == 120) {  //f9 pressed
				cancel();          
            }     
		})

		function get_header(){
			var d = new Date($.now());			
      		var date = d.getDate() + "/" + (d.getMonth()+1) + "/" + d.getFullYear();
			$('#date').text(date);

			$('#user').text(localStorage.user_name);

			$.ajax({
				type: "GET",
				url:"php/get_ware_shop.php",                            
				beforeSend: function(){
					EasyLoading.show({                           
						text: "กำลังโหลด"                            
					});
				},             
				success: function(data){  
					EasyLoading.hide();
					var obj = jQuery.parseJSON(data); 
					if(obj){
						$.each(obj, function(i, field){							
							if(obj[i][2] == "โกดัง"){  
								// if(!localStorage.ware_id_s){
								// 	if(i == 0){
								// 		localStorage.ware_id_s =  field.ware_id;
								// 		localStorage.ware_name_s =  field.ware_name;
								// 		b_id = field.ware_id;
								// 		type = "โกดัง";
								// 		localStorage.type =  type;
								// 		$('#btn-b').text(field.ware_name);								
								// 	}
								// }
								$('#b').append('<a class="dropdown-item text-center" href="#" onclick="setware('+field.ware_id+',\''+field.ware_name+'\',\'โกดัง\')">'+field.ware_name+'</a>');
							}else if(obj[i][2] == "หน้าร้าน"){ 
								// if(!localStorage.ware_id_s){
								// 	if(i == 0){
								// 		localStorage.ware_id_s =  field.shop_id;
								// 		localStorage.ware_name_s =  field.shop_name;
								// 		b_id = field.shop_id;
								// 		type = "หน้าร้าน";
								// 		localStorage.type =  type;
								// 		$('#btn-b').text(field.shop_name);								
								// 	}
								// }
								$('#b').append('<a class="dropdown-item text-center" href="#" onclick="setware('+field.shop_id+',\''+field.shop_name+'\',\'หน้าร้าน\')">'+field.shop_name+'</a>');
							}										
						}); 
					}
				}               
			}); 
		}

		var b_id,type;
		function setware(arg,arg2,arg3){
			b_id = arg;
			type = arg3;		
			$('#btn-b').text(arg2);	
			localStorage.ware_id_s = arg;			
			localStorage.ware_name_s = arg2;
			localStorage.type = arg3;
			$('#btn-b').text(arg2);	
			if($('#name').val() != ""){
				$.ajax({
					type: "POST",
					url:"php/get_sale.php",    
					data:{'prod_id' : prod_id,'cus_id':cus_id,'ware_id':b_id,'type':type},
					//async: false,                       
					beforeSend: function(){
						EasyLoading.show({                           
							text: "กำลังโหลด"                            
						});
					},             
					success: function(data){  
						EasyLoading.hide();
						var obj = jQuery.parseJSON(data);                                         
						$.each(obj, function(i, field){					
							min = obj[i].min_amount;
							if(min == 0){
								$.confirm({
									title: 'เตือน',
									content: 'สินค้าไม่มีใน' + $('#btn-b').text(),
									backgroundDismiss: true,
									buttons: {
										formSubmit: {
										text: 'ตกลง',
										btnClass: 'btn-regis',
										action: function () {
										}
										}
									}
								});
								if(localStorage.arr_prod_s){
									bool = false;
									add();
								}else{
									set_default();
								}
								
							}	                                                 
						});                                                   
					}               
				});  
			}           		
		}

		function setpay(arg){
			$('#btn-p').text(arg);			
		}

		function set_default(){
			$('#barcode').val("");
			$('#name').val("");		
			$('#price').val("");
			$('#total').val("");		
			$('#amount').val("1");		
			$('#name').focus();
		}

		arr_data = [];
		var count = 0;
  		function add(){
			if(bool){
				var code = $('#barcode').val();
				var price = $('#price').val();   
				var name = $('#name').val();    
				var amt = $('#amount').val();            
				if(name == "" || amt == "" || code == "" || price == ""){ 
					$('#name').focus();
						$.confirm({
							title: 'พบข้อผิดพลาด',
							content: 'กรุณากรอกข้อมูลให้ครบ',
							backgroundDismiss: true,
							buttons: {
								formSubmit: {
									text: 'ตกลง',
									btnClass: 'btn-regis',
									action: function () {
									}
								}
							}
						});
						return 0;
				}      
				var bottom = $(window).height() - $("#cnt-add").offset().top - $("#cnt-add").height();
				// Always scroll to the bottom
				if(bottom < 250){
					$("#cnt-add").css('max-height', $("#cnt-add").height());
					$("#cnt-add").animate({scrollTop: $('#cnt-add').prop('scrollHeight')});
				}   

				$("#cnt-add").append('<div id="add-'+count+'" class="row mgb-5">'+
						'<div class="col-2 nopd">'+
							'<div class="input-group-prepend">'+
								'<span id="span-no-'+count+'" class="input-group-text">'+(count+1)+'</span>'+
								'<input id="barcodee" value="'+code+'" type="text" class="form-control text-center" readonly>'+
							'</div>'+
						'</div>'+
						'<div class="col-4">'+
							'<input id="name-'+count+'" value="'+name+'" class="form-control text-center" rel="popover" data-img="'+img+'" readonly></input>'+
						'</div>'+
						'<div class="col-1 nopd">'+
							'<input id="amount-'+count+'" value="'+amt+'" type="number" class="form-control text-center no-spin" min="1" readonly>'+
						'</div>'+
						'<div class="col-2">'+
							'<input id="price-'+count+'" value="'+price+'" type="number" class="form-control text-center no-spin" min="0" readonly>'+
						'</div>'+
						'<div class="col-2">'+
							'<input id="total-'+count+'" value="'+$('#total').val()+'" type="number" class="form-control text-center no-spin" min="0" readonly>'+
						'</div>'+
						'<div class="col-1 nopd text-center">'+
						'<button id="btn-edit-'+count+'" class="btn btn-sm btn-primary mgr-5" onclick="edit('+count+');"> <i class="fas fa-pencil-alt"></i></button>'+
						'<button id="btn-save-'+count+'" class="btn btn-sm btn-success mgr-5" onclick="save('+count+');" hidden> <i class="fa fa-check"></i></button>'+
						'<button id="btn-trash-'+count+'" class="btn btn-sm btn-danger" onclick="remove('+count+');"> <i class="fa fa-trash"></i></button>'+
						'</div>'+
						"<script>" +
							"$('#name-"+count+"[rel=popover]').popover({" +
							"html: true," +
							"trigger: 'hover'," +
							"placement: 'left'," +
							"content: function(){" +
							"return '<img src='+$(this).data('img')+'>';}" +
							"});" +
						"</" + "script>" +
					'</div>');
					var sum = parseFloat($('#total-price').val());
					sum += parseFloat($('#total').val());
					$('#total-price').val(sum);

					item = {}   
					item ["count"] =  count;         
					item ["qr"] =  code;
					item ["prod_id"] =  prod_id;
					item ["name"] =  name;
					item ["old_price"] =  old_price; 
					item ["price"] =  price;               
					item ["amt"] =  amt;		
					item ["total"] =  $('#total').val();
					item ["img"] = img;
					item ["min"] = min;

					arr_data.push(item); 
					localStorage.setItem('arr_sale', JSON.stringify(arr_data));
					$("#cus").attr('disabled',true);
					count++;
					$("#btn-b").attr('disabled',true);	
			}			
				$('#barcode').val("");
				$('#name').val("");			
				$('#price').val("");
				$('#total').val("");			
				$('#amount').val("1");

				if(localStorage.arr_prod_s){
					var retrievedObject = localStorage.getItem('arr_prod_s');
					var arr_data2 = JSON.parse(retrievedObject);
					arr_data2.splice(0,1); 
					localStorage.setItem('arr_prod_s', JSON.stringify(arr_data2));  
					if(arr_data2.length == 0){
							localStorage.arr_prod_s = "";  
					}                                 
				}  
				if(localStorage.arr_prod_s){                    
					var retrievedObject = localStorage.getItem('arr_prod_s');
					var arr_data2 = JSON.parse(retrievedObject);                                   
					prod_id = arr_data2[0].prod_id;            
					get_sale(prod_id);            
				}else{                   
					$("#btn-folder").removeAttr('disabled');
					$("#btn-def").removeAttr('disabled');
					$("#name").removeAttr('readonly');
				}			
				$('#name').focus();
  	}

		function add_previous(){
			for(var i = 0;i < arr_data.length; i++){
				var bottom = $(window).height() - $("#cnt-add").offset().top - $("#cnt-add").height();
				// Always scroll to the bottom
				if(bottom < 250){
					$("#cnt-add").css('max-height', $("#cnt-add").height());
					$("#cnt-add").animate({scrollTop: $('#cnt-add').prop('scrollHeight')});
				}   

				$("#cnt-add").append('<div id="add-'+arr_data[i].count+'" class="row mgb-5">'+
						'<div class="col-2 nopd">'+
							'<div class="input-group-prepend">'+
								'<span id="span-no-'+arr_data[i].count+'" class="input-group-text">'+(arr_data[i].count+1)+'</span>'+
								'<input id="barcodee" value="'+arr_data[i].qr+'" type="text" class="form-control text-center" readonly>'+
							'</div>'+
						'</div>'+
						'<div class="col-4">'+
							'<input id="name-'+arr_data[i].count+'" value="'+arr_data[i].name+'" class="form-control text-center" rel="popover" data-img="'+arr_data[i].img+'" readonly></input>'+
						'</div>'+
						'<div class="col-1 nopd">'+
							'<input id="amount-'+arr_data[i].count+'" value="'+arr_data[i].amt+'" type="number" class="form-control text-center no-spin" min="1" readonly>'+
						'</div>'+
						'<div class="col-2">'+
							'<input id="price-'+arr_data[i].count+'" value="'+arr_data[i].price+'" type="number" class="form-control text-center no-spin" min="0" readonly>'+
						'</div>'+
						'<div class="col-2">'+
							'<input id="total-'+arr_data[i].count+'" value="'+arr_data[i].total+'" type="number" class="form-control text-center no-spin" min="0" readonly>'+
						'</div>'+
						'<div class="col-1 nopd text-center">'+
						'<button id="btn-edit-'+arr_data[i].count+'" class="btn btn-sm btn-primary mgr-5" onclick="edit('+arr_data[i].count+');"> <i class="fas fa-pencil-alt"></i></button>'+
						'<button id="btn-save-'+arr_data[i].count+'" class="btn btn-sm btn-success mgr-5" onclick="save('+arr_data[i].count+');" hidden> <i class="fa fa-check"></i></button>'+
						'<button id="btn-trash-'+arr_data[i].count+'" class="btn btn-sm btn-danger" onclick="remove('+arr_data[i].count+');"> <i class="fa fa-trash"></i></button>'+
						'</div>'+
						"<script>" +
							"$('#name-"+arr_data[i].count+"[rel=popover]').popover({" +
							"html: true," +
							"trigger: 'hover'," +
							"placement: 'left'," +
							"content: function(){" +
							"return '<img src='+$(this).data('img')+'>';}" +
							"});" +
						"</" + "script>" +
					'</div>');
					var sum = parseFloat($('#total-price').val());
					sum += parseFloat(arr_data[i].total);
					$('#total-price').val(sum);
					$("#cus").attr('disabled',true);
					$("#btn-b").attr('disabled',true);	
			}
		
		}

		var total_old;
  		function edit(arg){
			stop = false;
			for(i = 0; i < count; i++){
				if($("#btn-save-" + i).is(":visible")){
					stop = true;
				}
			}
			if(stop){
				return 0;
			}			   
			total_old = $("#total-" + arg).val();
			$("#amount-" + arg).prop('readonly', false);
			$("#price-" + arg).prop('readonly', false);         

			//change btn-edit to save
			$("#btn-edit-"+arg).prop('hidden', true);
			$("#btn-trash-"+arg).prop('hidden', true);
			$("#btn-save-"+arg).prop('hidden', false);

			$('#amount-'+arg).on("keyup input", function(){
				var price = $('#price-'+arg).val();
				var amt = $("#amount-" + arg).val();
				var total = price*amt;
				$('#total-'+arg).val(total);
			});

			$('#price-'+arg).on("keyup input", function(){
				var price = $('#price-'+arg).val();
				var amt = $("#amount-" + arg).val();
				var total = price*amt;
				$('#total-'+arg).val(total);
			});
  	}

		function remove(arg) {
			$.confirm({
				icon: 'fa fa-warning',
				title: 'แน่ใจหรือว่าต้องการลบ!',
				content: 'ต้องการลบรายการสินค้าออกจากรายการ!',
				buttons: {
					danger: {
						btnClass: 'btn-danger',
						text: 'ลบ',
						action: function () {		
							var sum = parseFloat($('#total-price').val());
      				var h_total = parseFloat($('#total-'+arg).val());		
							sum -= h_total;
							$('#total-price').val(sum);						
							$("#add-" + arg).remove();
							for (i = arg+1; i <= count-1; i++) {
								$("#span-no-" + (i)).text(i);								
								$("#span-no-"+ i).prop('id', 'span-no-'+ (i-1));						
								$("#amount-" + i).prop('id', 'amount-' + (i - 1));
								$("#name-" + i).prop('id', 'name-' + (i - 1));
								$("#price-" + i).prop('id', 'price-' + (i - 1));	
								$("#total-" + i).prop('id', 'total-' + (i - 1));						
								$("#add-" + i).prop('id', 'add-' + (i - 1));                 
								$("#btn-trash-" + i).attr('onclick', "remove(" + (i - 1) + ")");
								$("#btn-trash-" + i).prop('id', 'btn-trash-' + (i - 1));
								$("#btn-edit-" + i).attr('onclick', "edit(" + (i - 1) + ")");
								$("#btn-edit-" + i).prop('id', 'btn-edit-' + (i - 1));
								$("#btn-save-" + i).attr('onclick', "save(" + (i - 1) + ")");
								$("#btn-save-" + i).prop('id', 'btn-save-' + (i - 1));	
								arr_data[i].count--;						
							}
							arr_data.splice(arg, 1);
							localStorage.setItem('arr_sale', JSON.stringify(arr_data));	
							count--;							
							if(arr_data.length == 0){
								$("#cus").attr('disabled',false);
								$("#cus").focus();
								$("#btn-b").attr('disabled',false);
								localStorage.arr_sale = "";
							}
						}
					},
					ยกเลิก: function () { },
				}
			});
    }

  		function save(arg){
			if(parseInt($("#amount-"+arg).val()) > parseInt(arr_data[arg].min)){
				$.confirm({
					title: 'เตือน',
					content: 'สินค้ามีจำนวนไม่พอใน' + $('#btn-b').text() + ' สินค้ามีจำนวน ' + arr_data[arg].min,
					backgroundDismiss: true,
					buttons: {
						formSubmit: {
						text: 'ตกลง',
						btnClass: 'btn-regis',
						action: function () {
						}
						}
					}
				}); 
				$("#amount-" + arg).val(arr_data[arg].min);	 
				return 0;
			}	
			arr_data[arg].amt = $("#amount-"+arg).val();
			arr_data[arg].price = $("#price-"+arg).val(); 
			arr_data[arg].total = $('#total-'+arg).val(); 
			localStorage.setItem('arr_sale', JSON.stringify(arr_data));	   
			var sum = $('#total-price').val();
			sum = sum-total_old+parseFloat($('#total-'+arg).val());
			$('#total-price').val(sum);      

			$("#amount-" + arg).prop('readonly', true);
			$("#price-" + arg).prop('readonly', true);  

			$("#btn-edit-"+arg).prop('hidden', false);
			$("#btn-trash-"+arg).prop('hidden', false);
			$("#btn-save-"+arg).prop('hidden', true);
		}

		function check_bill(){
      var total = $('#total-price').val();    
			
      $('#net-price').val(total);
      $('#discount-money').val("");
      $('#final-price').val(total); 
      $('#get-money').val(""); 
      $('#change-money').val(""); 
			var pay = $('#btn-p').text();
			if(pay != "เงินสด"){
					$('#get-money').val("0");
					$('#change-money').val("0");
					$('#get-money').attr("readonly",true);
			}   
    }   

		arr_a4 = [];
		function save2db(){
			if(arr_data.length == 0 || cus_id == -1){
					return 0;
			}
			if($("#change-money").val() == "" || $("#get-money").val() == ""){
					return 0;
			}			
			var dis = $('#discount-money').val();
			if(dis == ""){
				dis = 0;
			}	
			arr_detail = [];
			var text = "";
      var texta4 = "";
			var c = 1;
			for(var i = 0 ; i < arr_data.length ; i ++){                
				if(arr_data[i].old_price != arr_data[i].price){
					item = {};                 
					item ["prod_id"] = arr_data[i].prod_id;                  
					item ["price"] =  arr_data[i].price;          

					arr_detail.push(item); 
				}
				texta4 = texta4 + '<div>'+
						'<div class="fl-spc tb-st no-bdt">'+(i+1)+'</div>' +
						'<div class="fl-15 tb no-bdt">'+arr_data[i].qr+'</div>' +
						'<div class="fl-45 tb no-bdt">'+arr_data[i].name+'</div>' +
						'<div class="fl-spc tb no-bdt">'+arr_data[i].amt+'</div>' +
						'<div class="fl-13 tb no-bdt">'+parseFloat(arr_data[i].price).toFixed(2)+'</div>' +
						'<div class="fl-13 tb no-bdt">'+parseFloat(arr_data[i].total).toFixed(2)+'</div>' +
					'</div>';		
				if(c < 7){								
					if(i == arr_data.length-1){
						for(var j = 0 ; j < 7-c;j++){
							texta4 = texta4 + '<div>'+
								'<div class="fl-spc tb-st no-bdt">&emsp;</div>' +
								'<div class="fl-15 tb no-bdt">&emsp;</div>' +
								'<div class="fl-45 tb no-bdt">&emsp;</div>' +
								'<div class="fl-spc tb no-bdt">&emsp;</div>' +
								'<div class="fl-13 tb no-bdt">&emsp;</div>' +
								'<div class="fl-13 tb no-bdt">&emsp;</div>' +
							'</div>';	
						}						
						arr_a4.push(texta4);
					}
					c++;
				}else if(c == 7){				
					arr_a4.push(texta4);
					c = 1;
					texta4 = "";
				}
				text = text + " <div class='left'>"+arr_data[i].amt+"</div> <div class='mid'>"+arr_data[i].name+"</div> <div class='right'>"+arr_data[i].price+"</div>";
			} 	
			var d = new Date($.now());
			var datetime = d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();	
			var print = $('input[name=print-radio]:checked').val();
      var print_type = $('input[name=print-option]:checked').val();	
			var vat = $('input[name=pay-radio]:checked').val();		
			json_string = JSON.stringify(arr_data); 
			json_detail = JSON.stringify(arr_detail);           
			var dataString =  "JSON=" + json_string + "&JSOND=" + json_detail + "&ware_id=" + b_id + "&date=" + datetime + "&type=" + type
			+ "&cus_id=" + cus_id + "&pay=" + $("#btn-p").text() + "&net=" + $('#net-price').val() + "&dis=" + dis
			+ "&total=" + $('#final-price').val() + "&get_price=" + $('#get-money').val() + "&chng=" + $('#change-money').val() + "&user_id=" + localStorage.user_id;
			//alert(dataString);
			var msg_alert = "";
			for(var i = 0 ; i < arr_data.length;i++){
				msg_alert += arr_data[i].name + " คงเหลือ " + (arr_data[i].min-arr_data[i].amt) + '<br>';
			}	

			if(print == "print"){
				var WinPrint  = window.open();
			} 			
			$.ajax({
					type: "POST",
					url:"php/save_order.php",           
					data: dataString,
					beforeSend: function(){
						EasyLoading.show({                           
							text: "กำลังโหลด"                            
						});
					},               
					success: function(data){  
						EasyLoading.hide();
							if(data != "fail"){
								if(print == "print"){
									var temp = data.split(" ");
									var order_num = temp[0];
									
									if(print_type == "bill"){
									var dt = datetime.split(" ");
									var time = dt[1];
									var d = dt[0].split("-");
									var date = d[2] + "/" + d[1] + "/" + d[0];
									WinPrint.document.write("<html><head><link href='https://fonts.googleapis.com/css?family=Maitree' rel='stylesheet'></head><body>");
									WinPrint.document.write("<style>@page {size: auto; margin: 0mm;} body{font-family: 'Maitree'; line-height: 1.5; font-size: 0.9em;} .txt-right{ margin-right: 0.5cm; text-align:right; float: right; } .txt-left{ margin-left: 0.5cm; float: left; width: 50%; }.txt-left-100{ margin-left: 0.5cm; float: left; width: 100%; } .txt-ct{ float: center; text-align: center; margin-bottom: 0.2em} .mid{float: left; width: 3.5cm; text-align: right;} .left{margin-left: 0.5cm; float: left; width: 0.3cm; text-align: center;} .right{margin-right: 0.5cm; float: left; width: 2.7cm; text-align: right;}.bold{font-weight: bold;}</style>" +
										"<div style='width: 7.5cm;'>"+
											"<div class='txt-ct'>DD MOTOR SPORT</div>"+
											"<div class='txt-ct'>B-24, B-28 อาคารศรีวรจักร ถ.หลวงป้อมปราบศัตรูพ่าย</div>"+
											"<div class='txt-ct'>โทร. 065-5028828 , 097-0631169</div>"+
											"<div class='txt-ct bold' style='margin-top: 0.5em; margin-bottom: 0.5em;'>ใบเสร็จรับเงิน</div>"+						
											"<div class='txt-left-100'>ลูกค้า : "+$('#cus').val()+"</div>"+
											"<div class='txt-left-100'>ประเภท : "+$('#btn-p').text()+"</div>"+
											"<div class='txt-left-100'>เลขที่บิล :  "+order_num+"</div>"+
											"<div class='txt-left' style='letter-spacing: -0.5px;'>วันที่ขาย : "+date+"</div>"+
											"<div class='txt-right' style='margin-bottom: 5px;'>เวลา : "+time+"</div>"+
											
											"<hr style='width: 90%; border-top: 1px dashed; border-bottom: none;'>"+
											"<div class='left bold'>จน.</div> <div class='mid bold'>รายการ</div> <div class='right bold'>ราคา</div>"+
											""+text+""+
											"<hr style='width: 90%; border-top: 5px; border-top: 1px dashed; border-bottom: none;'>"+
											"<div class='txt-left'>ราคารวม : </div>"+
											"<div class='txt-right'>"+$('#net-price').val()+" บาท</div><br>"+
											"<div class='txt-left'>ส่วนลด : </div>"+
											"<div class='txt-right'>"+dis+" บาท</div><br>"+
											"<div class='txt-left'>สุทธิ : </div>"+
											"<div class='txt-right'>"+$('#final-price').val()+" บาท</div><br>"+
											"<div class='txt-left' style='width: 30%;'>รับ / ทอน : </div>"+
											"<div class='txt-right'><span style='margin-right: 20px'>"+$('#get-money').val()+" บาท</span><span> "+$('#change-money').val()+" บาท</span></div><br><br>"+
											"<div class='txt-ct' style='margin-bottom: 0.5em;'>ขอบคุณที่ใช้บริการ</div>"+
											"<div class='txt-ct'>พนักงานขาย : "+localStorage.user_name+"</div>"+
										"</div>");
									WinPrint.document.write('</body></html>');
									WinPrint.document.close();
									WinPrint.focus();
									setTimeout(function() {
										WinPrint.print();
										WinPrint.close();		
										$.confirm({
                            title: 'จำนวนคงเหลือใน'+ $('#btn-b').text(),
                            content: msg_alert,
                            backgroundDismiss: false,
                            buttons: {
                                formSubmit: {
                                text: 'ตกลง',
                                btnClass: 'btn-regis',
                                action: function () {
																	cancel();    
                                }
                                }
                            }
                        });    
									}, 250);										
								}
									else if(print_type == "a4"){
										var dt = datetime.split(" ");
										var time = dt[1];
										var day = dt[0].split("-");
										var date = day[2] + "/" + day[1] + "/" + day[0];
										var credit = parseInt($('#btn-p').text().substr(8,2));
										var d = new Date($.now());
										d.setDate(d.getDate() + credit);
										var date_ex = d.getDate() + "/" + (d.getMonth()+1) + "/" +   d.getFullYear();
										WinPrint.document.write("<html><head><link href='https://fonts.googleapis.com/css?family=Maitree' rel='stylesheet'>");
										WinPrint.document.write(" <style>@media print {body {-webkit-print-color-adjust: exact;}} @page {size: auto; margin: 0;}.fl-spc{float: left; width: 5%;}.fl-9{float: left; width: 9%;}.fl-12{float: left; width: 12.752%;}.fl-13{float: left; width: 13.05%;}.fl-14{float: left; width: 13.88%;}.fl-15{float: left; width: 15%;}.fl-20{float: left; width: 20%; text-align: center;}.fl-25{float: left; width: 25%; text-align: center;}.fl-35{float: left; width: 35%; text-align: center;}.fl-45{float: left; width: 45%; text-align: center;}.fl-80{float: left; width: 80%; text-align: center;}.ctn{position: relative; width: 297mm; height: 10%; padding: 10mm 15mm 0mm 10mm; font-family: 'Maitree';}.tb-st{border: 1px solid black; text-align: center; padding: 3px;}.tb{border: 1px solid black; text-align: center; padding: 3px; border-left: none;}.no-bdt{border-top: none;}.no-bdbtm{border-bottom: none;}.bold{font-weight: bold;}.ccc{background-color: #ccc;}.pd-15{padding-top: 15px;}.pd-16{padding-top: 16px;}.mg-5{margin-top: 5px;}</style></head><body>");
										for(var m = 0;m < arr_a4.length;m++){
											WinPrint.document.write("<div class='ctn' style='margin-top: -8mm;'>" +
												"<div class='fl-35'>" +
													"<img style='width: 250px; height: 150px;' src='img/logo.jpg'>" +
												"</div>" +
												'<div class="fl-spc">&emsp;</div>' +
												"<div class='fl-25' style='margin-top: 30px;'>" +
												'<h1 style="border: 1px solid #555; border-radius: 10px; padding-top: 10px; padding-bottom: 10px; background-color: #555 !important; color: white; font-size: 210%;">ใบรายการขาย</h1>' +
												'</div>' +
												'<div class="fl-20">&emsp;</div>' +
												"<div class='fl-15' style='text-align: center; margin-bottom: 30px;'>" +
													'<h4 style="border: 1px solid black; background-color: #cccccc; padding-top: 5px; padding-bottom: 5px; width: 90%;">ต้นฉบับ</h4>' +
												'</div>' +

												'<div style=" text-align: right;">' +
													'<p style="width: 99%;"><span class="bold">เลขที่  : </span><span>&emsp;'+order_num+'</span></p>' +
													'<p style="width: 99%; margin-top: -15px;"><span class="bold">วันที่  : </span>&emsp;&emsp; <span>'+date+'</span></p>' +
													'<p style="width: 99%; margin-top: -15px;"><span class="bold">เครดิต : </span><span style="margin-left: 98px;">'+credit+'</span></p>' +
												'</div>'+
												
												'<div style=" text-align: left; margin-top: -41px;">'+
													'&emsp; <span class="bold">สถานที่ส่งสินค้า : </span><span>&emsp;รถบริษัท DD MOTOR SPORT B-24, B-28 อาคารศรีวรจักร ถ.หลวงป้อมปราบศัตรูพ่าย</span>'+
												'</div>' +

												'<div style="margin-top: 5px;">' +
													'<div class="fl-80 tb-st no-bdbtm" style="text-align: left;">&emsp; <span class="bold">ชื่อลูกค้า : </span><span>&emsp;'+$('#cus').val()+'</span> &emsp;&emsp;&emsp; <span class="bold">โทร : </span><span>&emsp;'+cus_tel+'</span></div>' +
													'<div class="fl-9 tb no-bdbtm ccc bold">วันครบกำหนด</div>' +
													'<div class="fl-9 tb no-bdbtm ccc bold">ทำรายการโดย</div>' +
												'</div>'+

												'<div style="margin-top: 5px;">' +
													'<div class="fl-80 tb-st no-bdt" style="text-align: left;">&emsp; <span class="bold">ที่อยู่ : </span><span>&emsp;'+cus_addr+'</span></div>'+
													'<div class="fl-9 tb" style="margin-top: -1px;">'+date_ex+'</div>'+
													'<div class="fl-9 tb" style="margin-top: -1px;">'+localStorage.user_name+'</div>'+
												'</div>' +

												'<div>'+
													'<div class="fl-spc tb-st no-bdt ccc bold">ที่</div>'+
													'<div class="fl-15 tb no-bdt ccc bold">รหัสสินค้า</div>'+
													'<div class="fl-45 tb no-bdt ccc bold">รายการ</div>'+
													'<div class="fl-spc tb no-bdt ccc bold">จำนวน</div>'+
													'<div class="fl-13 tb no-bdt ccc bold">ราคา / หน่วย</div>'+
													'<div class="fl-13 tb no-bdt ccc bold">จำนวนเงิน</div>' +
												'</div>' +
													arr_a4[m] +
												'<div>' +
													'<div class="fl-spc tb-st no-bdt pd-15">จำนวน</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................ กล่อง</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................... ลัง</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................... มัด</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................ ม้วน</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................... ชิ้น</div>' +
													'<div class="fl-13 tb no-bdt pd-15">รวม / Total</div>' +
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat($('#net-price').val()).toFixed(2)+'</div>' +
												'</div>' +

												'<div>' +
													'<div class="fl-14 tb-st no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-13 tb no-bdt pd-15">ส่วนลด / Discount</div>' +
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat(dis).toFixed(2)+'</div>' +
												'</div>'+

												'<div>'+
													'<div class="fl-14 tb-st no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-13 tb no-bdt pd-15">สุทธิ / Net</div>'+
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat($('#final-price').val()).toFixed(2)+'</div>'+
												'</div>'+

												'<div>'+
													'<div class="fl-14 tb-st no-bdt no-bdbtm pd-16 ">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-13 tb no-bdt pd-15">ภาษีมูลค่าเพิ่ม / Vat</div>'+
													'<div class="fl-13 tb no-bdt pd-15">0.00</div>'+
												'</div>'+

												'<div>'+
													'<div class="fl-14 tb-st no-bdt pd-15">ผู้ขายของ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">คลังสินค้า/ผู้ตรวจสอบ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">ผู้ส่งของ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">ผู้รับของ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">ผู้มีอำนาจลงนาม</div>'+
													'<div class="fl-13 tb no-bdt pd-15">ทั้งสิ้น / Grand Total</div>'+
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat($('#final-price').val()).toFixed(2)+'</div>'+
												'</div>'+
											'</div>'+

											"<div class='ctn' style='margin-top: 155mm; page-break-after: always;'>" +
												'<div>--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div>'+
												"<div class='fl-35'>" +
													"<img style='width: 250px; height: 150px;' src='img/logo.jpg'>" +
												"</div>" +
												'<div class="fl-spc">&emsp;</div>' +
												"<div class='fl-25' style='margin-top: 30px;'>" +
												'<h1 style="border: 1px solid #555; border-radius: 10px; padding-top: 10px; padding-bottom: 10px; background-color: #555 !important; color: white; font-size: 210%;">ใบรายการขาย</h1>' +
												'</div>' +
												'<div class="fl-20">&emsp;</div>' +
												"<div class='fl-15' style='text-align: center; margin-bottom: 30px;'>" +
													'<h4 style="border: 1px solid black; background-color: #cccccc; padding-top: 5px; padding-bottom: 5px; width: 90%;">สำเนา</h4>' +
												'</div>' +

												'<div style=" text-align: right;">' +
													'<p style="width: 99%;"><span class="bold">เลขที่  : </span><span>&emsp;'+order_num+'</span></p>' +
													'<p style="width: 99%; margin-top: -15px;"><span class="bold">วันที่  : </span>&emsp;&emsp; <span>'+date+'</span></p>' +
													'<p style="width: 99%; margin-top: -15px;"><span class="bold">เครดิต : </span><span style="margin-left: 98px;">'+$('#btn-p').text().substr(8,2)+'</span></p>' +
												'</div>'+
												
												'<div style=" text-align: left; margin-top: -41px;">'+
													'&emsp; <span class="bold">สถานที่ส่งสินค้า : </span><span>&emsp;รถบริษัท DD MOTOR SPORT B-24, B-28 อาคารศรีวรจักร ถ.หลวงป้อมปราบศัตรูพ่าย</span>'+
												'</div>' +

												'<div style="margin-top: 5px;">' +
													'<div class="fl-80 tb-st no-bdbtm" style="text-align: left;">&emsp; <span class="bold">ชื่อลูกค้า : </span><span>&emsp;'+$('#cus').val()+'</span> &emsp;&emsp;&emsp; <span class="bold">โทร : </span><span>&emsp;'+cus_tel+'</span></div>' +
													'<div class="fl-9 tb no-bdbtm ccc bold">วันครบกำหนด</div>' +
													'<div class="fl-9 tb no-bdbtm ccc bold">ทำรายการโดย</div>' +
												'</div>'+

												'<div style="margin-top: 5px;">' +
													'<div class="fl-80 tb-st no-bdt" style="text-align: left;">&emsp; <span class="bold">ที่อยู่ : </span><span>&emsp;'+cus_addr+'</span></div>'+
													'<div class="fl-9 tb" style="margin-top: -1px;">'+date_ex+'</div>'+
													'<div class="fl-9 tb" style="margin-top: -1px;">'+localStorage.user_name+'</div>'+
												'</div>' +

												'<div>'+
													'<div class="fl-spc tb-st no-bdt ccc bold">ที่</div>'+
													'<div class="fl-15 tb no-bdt ccc bold">รหัสสินค้า</div>'+
													'<div class="fl-45 tb no-bdt ccc bold">รายการ</div>'+
													'<div class="fl-spc tb no-bdt ccc bold">จำนวน</div>'+
													'<div class="fl-13 tb no-bdt ccc bold">ราคา / หน่วย</div>'+
													'<div class="fl-13 tb no-bdt ccc bold">จำนวนเงิน</div>' +
												'</div>' +
													arr_a4[m] +						
												'<div>' +
													'<div class="fl-spc tb-st no-bdt pd-15">จำนวน</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................ กล่อง</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................... ลัง</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................... มัด</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................ ม้วน</div>' +
													'<div class="fl-12 tb no-bdt pd-15">................... ชิ้น</div>' +
													'<div class="fl-13 tb no-bdt pd-15">รวม / Total</div>' +
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat($('#net-price').val()).toFixed(2)+'</div>' +
												'</div>' +

												'<div>' +
													'<div class="fl-14 tb-st no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>' +
													'<div class="fl-13 tb no-bdt pd-15">ส่วนลด / Discount</div>' +
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat(dis).toFixed(2)+'</div>' +
												'</div>'+

												'<div>'+
													'<div class="fl-14 tb-st no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">&emsp;</div>'+
													'<div class="fl-13 tb no-bdt pd-15">สุทธิ / Net</div>'+
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat($('#final-price').val()).toFixed(2)+'</div>'+
												'</div>'+

												'<div>'+
													'<div class="fl-14 tb-st no-bdt no-bdbtm pd-16 ">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-14 tb no-bdt no-bdbtm pd-16">................................</div>'+
													'<div class="fl-13 tb no-bdt pd-15">ภาษีมูลค่าเพิ่ม / Vat</div>'+
													'<div class="fl-13 tb no-bdt pd-15">0.00</div>'+
												'</div>'+

												'<div>'+
													'<div class="fl-14 tb-st no-bdt pd-15">ผู้ขายของ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">คลังสินค้า/ผู้ตรวจสอบ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">ผู้ส่งของ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">ผู้รับของ</div>'+
													'<div class="fl-14 tb no-bdt pd-15">ผู้มีอำนาจลงนาม</div>'+
													'<div class="fl-13 tb no-bdt pd-15">ทั้งสิ้น / Grand Total</div>'+
													'<div class="fl-13 tb no-bdt pd-15">'+parseFloat($('#final-price').val()).toFixed(2)+'</div>'+
												'</div>'+
											'</div>');
										}				
										WinPrint.document.write('</body></html>');
										WinPrint.document.close();
										WinPrint.focus();
										setTimeout(function() {
											WinPrint.print();
											WinPrint.close();	
											$.confirm({
                            title: 'จำนวนคงเหลือใน'+ $('#btn-b').text(),
                            content: msg_alert,
                            backgroundDismiss: false,
                            buttons: {
                                formSubmit: {
                                text: 'ตกลง',
                                btnClass: 'btn-regis',
                                action: function () {
																	cancel();    
                                }
                                }
                            }
                        });    
										}, 250);										
									}			
								}else{
									$.confirm({
											title: 'จำนวนคงเหลือใน'+ $('#btn-b').text(),
											content: msg_alert,
											backgroundDismiss: false,
											buttons: {
													formSubmit: {
													text: 'ตกลง',
													btnClass: 'btn-regis',
													action: function () {
														cancel();    
													}
													}
											}
									});    
								}						
							}else{
									$.confirm({
											title: 'พบข้อผิดพลาด',
											content: 'ลองอีกครั้ง',
											backgroundDismiss: true,
											buttons: {
													formSubmit: {
													text: 'ตกลง',
													btnClass: 'btn-regis',
													action: function () {
													}
													}
											}
									});
							}
					}               
			});
		}

		function set_print_title(){
			text_html = "<span><i class='fa fa-print'></i></span>";
			$('input[name=print-radio]').each(function () {
				if ($(this).is(":checked")) {
					checked = $(this).val();
					if (checked == "no") {
						$("#print-title").text("ไม่พิมพ์ ");
						$("#print-title").append(text_html);
						$('#pay-title').attr('disabled',true);
					} else if (checked == "print") {
						$('input[name=print-option]').each(function () {
							if ($(this).is(":checked")) {
								check = $(this).val();
								if(check == "bill"){
									$("#print-title").text("ใบเสร็จ ");
									$('#pay-title').attr('disabled',true);
								}else{
									$("#print-title").text("ใบรายการขาย ");
									$('#pay-title').attr('disabled',false);
								}
								$("#print-title").append(text_html);
							}
						});
					}
				}
			});
		}

		function set_pay_title() {
			text_html = "<span><i class='fas fa-money-bill-wave'></i></span>";		
				$('input[name=pay-radio]').each(function () {
					if ($(this).is(":checked")) {
						checked = $(this).val();
						if (checked == "no vat") {
							$("#pay-title").text("ไม่รวม vat ");						
						}else if (checked == "vat") {
							$("#pay-title").text("รวม vat ");
						}						
						$("#pay-title").append(text_html);
					}
				});
			}

		function logout(){
			localStorage.clear();
		}

		function cancel(){
			localStorage.arr_sale = "";
			localStorage.arr_prod_s = "";
			localStorage.cus_name = "";
			localStorage.cus_id = "";
			localStorage.cus_type = "";
			localStorage.cus_addr = "";
			localStorage.cus_tel = "";
			localStorage.ware_id_s = "";
			localStorage.ware_name_s = "";
			localStorage.type = "";
			location.reload();
		}

		function selectfolder() {
			if(cus_id == -1 || $('#cus').val() == ""){			
				$.alert({
					icon: 'fa fa-warning',
					title: 'เตือน',
					content: "กรุณาใส่ชื่อลูกค้าก่อนทำรายการ"
				});
				$("#cus").focus();
				return 0;
			}else if($('#btn-b').text() == "เลือกโกดัง/หน้าร้าน"){
				$.confirm({
					title: 'พบข้อผิดพลาด',
					content: 'กรุณาเลือกโกดัง/หน้าร้านก่อนทำรายการ',
					backgroundDismiss: true,
					buttons: {
						formSubmit: {
							text: 'ตกลง',
							btnClass: 'btn-regis',
							action: function () {
							}
						}
					}
				});  
				return 0;
			}			
			window.location = "web_folder.html?from=sale";            
		} 
		
  </script>

  <style>
  	label{
  		color: #666;
  		margin-right: 15px; margin-top: 5px;
  	}
  	#btn-b{
  		width: 50%; background-color: #666; border-color: #666; color: white;
  	}
  	#btn-b:focus{
  		outline: 0;
  	}
		#btn-p{
  		width: 50%; background-color: #666; border-color: #666; color: white;
  	}
  	#btn-p:focus{
  		outline: 0;
  	}
  	a{
  		color: #999;
  	}
  	a:hover{
  		color: #666;
  	}
	.active{
		color: #666;
	}
  </style>
</head>
<body>
	<div class="container-fullwidth justify-content-center">
		<nav class="navbar navbar-expand-md navbar-dark">
        	<div class="collapse navbar-collapse justify-content-md-center" id="navbarCollapse">
          	<h3 id="nav-title">ขายสินค้า</h3>
        	</div>
      	</nav>
      	<div class="container">
      		<div class="row" style="margin-top: 2px;">
      			<div class="col-12 text-center">
      				<a href="web_sale.html" class="mgr-20 active">ขายสินค้า</a>
      				<a href="web_import.html" class="mgr-20">นำสินค้าเข้า</a>
							<a href="web_stock.html" class="mgr-20">เช็คสต๊อก</a>
							<a href="web_export.html" class="mgr-20">สินค้าออกโกดัง</a>						
							<a href="web_select.html" class="mgr-20">รายการย้อนหลัง</a>
							<a href="web_qrprint.html" class="mgr-20">พิมพ์คิวอาร์</a>
							<a href="" class="mgr-20" onclick="logout()">ออกจากระบบ</a>
      			</div>
      		</div>
      	</div><br><br>

      	<div class="container-fullwidth">
      		<div id="head" class="row mgb-5" style="padding-left: 2%; padding-right: 2%;">
      		  <div class="col-2 text-center" style="color: #666;">วันที่</div>
      		  <div class="col-2 text-center" style="color: #666;">ลูกค้า</div>
      		  <div class="col-3 text-center" style="color: #666;">ขายจาก</div>
      		  <div class="col-3 text-center" style="color: #666;">รูปแบบการชำระเงิน</div>
      		  <div class="col-2 text-center" style="color: #666;">ผู้ทำรายการ</div>
      		</div>
      	</div>

      	<div class="container-fullwidth">
      		<div class="row" style="padding-left: 2%; padding-right: 2%;">
      			<div id="date" class="col-2 text-center" style="margin-top: 5px; color: #666;">12/5/2018</div>
      			<div class="col-2 text-center nopd">
      				<input id='cus' type='text' class='form-control text-center' autofocus data-index="1">
      			</div>
      			
      			<div class="col-3 text-center nopd">
      				<button id="btn-b" type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="background-color: #666;">เลือกโกดัง/หน้าร้าน</button>

      				<div id="b" class="dropdown-menu" aria-labelledby="dropdownMenuButton">

      				</div>
      			</div>
      			<div class="col-3 text-center">
      				<button id="btn-p" type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="background-color: #666;">เงินสด</button>

      				<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
						<a class="dropdown-item text-center" href="#" onclick="setpay('เงินสด')">เงินสด</a>
						<a class="dropdown-item text-center" href="#" onclick="setpay('เครดิต (30)')">เครดิต (30)</a>
						<a class="dropdown-item text-center" href="#" onclick="setpay('เครดิต (60)')">เครดิต (60)</a>
						<a class="dropdown-item text-center" href="#" onclick="setpay('เครดิต (90)')">เครดิต (30)</a>
      				</div>
      			</div>
      			<div id="user" class="col-2 text-center nopd" style="margin-top: 5px; color: #666;">
      				ชายเมืองสิงค์
      			</div>
      		</div>
      	</div><hr style="width: 85%;">
      	
      	<div class="container-fullwidth">
      		<div id="head" class="row mgb-5">
      		  <div class="col-2 text-center nopd">บาร์โค้ด</div>
      		  <div class="col-4 text-center">ชื่อสินค้า</div>
      		  <div class="col-1 text-center">จำนวน</div>
      		  <div class="col-2 text-center">ราคา / หน่วย</div>
      		  <div class="col-2 text-center">ราคารวม</div>
      		</div>
      	</div>
	
		<div id="cnt-add" class="container-fullwidth" style="overflow-y: auto;">
			<!-- Append Here!! -->
		</div>

		<div class="container-fullwidth">
			<!-- Input -->
			<div class="row" >
			  <div class="col-2 nopd">
			    <div class='input-group-prepend'>
			      <span id="span-no" class='input-group-text'>#</span>
			      <input id='barcode' type='text' class='form-control text-center' readonly>
			    </div>
			  </div>
			  <div class='col-4'>
			    <input id="name" class="form-control text-center" data-index="2">
			  </div>
			  <div class='col-1 nopd'>
			    <input id='amount' type='number' class='form-control text-center no-spin' min='1' data-index="3">
			  </div>
			  <div class='col-2'>
			    <input id='price' type='number' class='form-control text-center no-spin' min='0' data-index="4">
			  </div>
			  <div class='col-2'>
			    <input id='total' type='number' class='form-control text-center no-spin' min='0' readonly>
			  </div>
			  <div class="col-1 nopd text-center">
			  	<button class="btn btn-sm btn-primary" disabled> <i class="fas fa-pencil-alt"></i></button>
			  	<button class="btn btn-sm btn-danger" disabled> <i class="fa fa-trash"></i></button>
			  	<button class="btn btn-sm btn-success" hidden disabled> <i class="fa fa-check"></i></button>
			  </div>
			</div><br>
			<div class="row">
				<div class="col-12 text-right">
					<button id="btn-add" class="btn btn-md btn-success" style="margin-right: 5px;" onclick="add();">เพิ่มสินค้า (F2)</button>
					<button id="btn-folder" class="select_folder btn btn-md btn-primary" style="margin-right: 5px;" onclick="selectfolder();">เลือกสินค้า (F7)</button>
					<button id="btn-def" class="btn btn-md btn-danger" onclick="set_default();">ค่าเริ่มต้น (F4)</button>
				</div>
			</div>
		</div>

		<div id="ctn-bttm" class="container-fullwidth fixed-bottom" style="margin-bottom: 15px; z-index: 0;">
		  <div class="row">
		    <div class="col-1 text-center conclu-txt nopd">
		      <h4>รวม : </h4>
		    </div>
		    <div class="col-1 text-center conclu-price nopd">
		      <input id="total-price" type="number" value="0" class="form-control form-control-lg text-center no-spin no-border conclu-price-input" style="background: #767676; color: #5dbe5d" readonly>
		    </div>
		    <div class="col-1 text-center nopd">
		    
		    </div>
		    <div class="col-1 text-center nopd">
		     
		    </div>
		    <div class="col-1 text-center nopd">
		     
		    </div>		    
		    <div class="col-3 text-right nopd" style="padding-top: 10px;">
						<button id="btn_checkbill" class="btn btn-danger" data-toggle="modal" data-target="#myModal" onclick="check_bill()">คิดเงิน (F8)</button>
						<button class="btn btn-danger" onclick="cancel()">ยกเลิก (F9)</button>
		    </div>
		    <div class="col-3 text-right nopd" style="padding-top: 10px;">
				<button id="print-title" class="btn btn-info" data-toggle="modal" data-target="#printModal" style="margin-right: 10px;">ใบรายการขาย
				  <span>
				    <i class="fa fa-print"></i>
				  </span>
				</button>
				<button id='pay-title' class="btn btn-warning" data-toggle="modal" data-target="#payModal">ไม่รวม vat
		    	  <span>
					<i class="fas fa-money-bill-wave"></i>
		    	  </span>
		    	</button>
		    </div>
		</div>
	</div>

	<!-- The Modal -->
	<div class="modal fade" id="myModal" tabindex='-1'>
	  <div class="modal-dialog modal-md modal-dialog-centered">
	    <div class="modal-content">
	      <!-- Modal Header -->
	      <div class="col-12 text-center" style="margin-top: 15px;">
	        <h4 class="modal-title">คิดเงิน</h4>
	        <hr style="width: 70%;">
	      </div>

	      <!-- Modal body -->
	      <div class="modal-body">
	        <div class="container">
	          <div class="row">
	            <div class="col-2"></div>
	            <div class="col-3 text-center" style="border: solid #767676; padding-top: 5px;">
	              <h3>รวม : </h3>
	            </div>
	            <div class="col-5 text-center" style="border: solid #767676; background: #767676;">
	              <input id="net-price" type="number" class="form-control form-control-lg text-center no-spin no-border check-bill-input" style="background: #767676; color: #5dbe5d;"
	                readonly>
	            </div>
	            <div class="col-2"></div>
	          </div><br>

	          <div class="row">
	            <div class="col-2"></div>
	            <div class="col-3 text-center" style="border: solid #767676; padding-top: 5px;"><h3>ลด : </h3></div>
	            <div class="col-5 text-center" style="border: solid #767676; background: #767676;">
	              <input id="discount-money" autofocus  data-index="5" type="number" class="form-control form-control-lg text-center no-spin no-border check-bill-input" style="background: #767676; color: #fd8b5e;">
	            </div>
	            <div class="col-2"></div>
	          </div> <br>

	          <div class="row">
	            <div class="col-2"></div>
	            <div class="col-3 text-center" style="border: solid #767676; padding-top: 5px;"><h3>สุทธิ : </h3></div>
	            <div class="col-5 text-center" style="border: solid #767676; background: #767676;">
	              <input id="final-price" type="number" class="form-control form-control-lg text-center no-spin no-border check-bill-input" style="background: #767676; color: #ffffff;"
	              readonly>
	            </div>
	            <div class="col-2"></div>
	          </div>
	          <br>

	          <div class="row">
	            <div class="col-2"></div>
	            <div class="col-3 text-center" style="border: solid #767676; padding-top: 5px;"><h3>รับ : </h3></div>
	            <div class="col-5 text-center" style="border: solid #767676; background: #767676;">
	              <input id="get-money" type="number" data-index="6" class="form-control form-control-lg text-center no-spin no-border check-bill-input" style=" background: #767676;  color: #DBBD5B;">
	            </div>
	            <div class="col-2"></div>
	          </div> <br>

	          <div class="row">
	            <div class="col-2"></div>
	            <div class="col-3 text-center" style="border: solid #767676; padding-top: 5px;"><h3>ทอน : </h3></div>
	            <div class="col-5 text-center" style="border: solid #767676; background: #767676;">
	              <input id="change-money" type="number" class="form-control form-control-lg text-center no-spin no-border check-bill-input" style="background: #767676; color: #A5FAE9"
	              readonly>
	            </div>
	            <div class="col-2"></div>
	          </div> <br>
	      </div> <br>

	      <!-- Modal footer -->
	      <div class="col-12 text-center">
	        <button id="btn_save" type="button" class="btn btn-success" data-dismiss="modal" onclick="save2db()" style="margin-right: 15px;">บันทึก</button>
	        <button type="button" class="btn btn-secondary" data-dismiss="modal">ปิด</button>
	      </div><br>
	    </div>
	  </div>
	</div>
	</div>

	<!-- Print Modal -->
	<div class="modal fade" id="printModal" tabindex='-1'>
	  <div class="modal-dialog modal-md modal-dialog-centered">
	    <div class="modal-content">
	      <!-- Modal Header -->
	      <div class="col-12 text-center" style="margin-top: 15px;">
	        <h4 class="modal-title">ตั้งค่าการพิมพ์</h4>
	        <hr style="width: 70%;">
	      </div>

	      <!-- Modal body -->
	      <div class="modal-body">
	        <div class="col-12 text-center">
	          <label class="radio-inline" style="font-size: 120%;">
	            <input type="radio" name="print-radio" value="print" checked>พิมพ์</label>
	          <label class="radio-inline" style="font-size: 120%;">
	            <input type="radio" name="print-radio" value="no">ไม่พิมพ์</label>
	        </div>
	        <div id="print-option-title" class="col-12 text-center">
	          <h5 style="text-decoration: underline;">ตัวเลือก</h5>
	        </div>
	        <div id="print-option" class="col-12 text-center">
	          <label class="radio-inline" style="font-size: 120%;">
	            <input id="bill" type="radio" name="print-option" value="bill">ใบเสร็จ</label>
	          <label class="radio-inline" style="font-size: 120%;">
	            <input id="a4" type="radio" name="print-option" value="a4" checked>ใบรายการขาย(A4)</label>
	        </div><br>
	        <!-- Modal footer -->
	        <div class="col-12 text-center">
						<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="set_print_title();">บันทึก</button>
					</div>
	        <br>
	      </div>
	    </div>
	  </div>
	</div>

	<!-- Pay Modal -->
	<div class="modal fade" id="payModal" tabindex='-1'>
	  <div class="modal-dialog modal-md modal-dialog-centered">
	    <div class="modal-content">
	      <!-- Modal Header -->
	      <div class="col-12 text-center" style="margin-top: 15px;">
	        <h4 class="modal-title">เงื่อนไขการชำระเงิน</h4>
	        <hr style="width: 70%;">
	      </div>

	      <!-- Pay body -->
	      <div class="modal-body">
	        <div class="col-12 text-center">
	          <label class="radio-inline">
	            <input type="radio" name="pay-radio" value="no vat" checked>ไม่รวม vat</label>
	          <label class="radio-inline">
	            <input type="radio" name="pay-radio" value="vat">รวม vat</label>	         
	        </div>	       
	        <br>
	        <!-- Modal footer -->
	        <div class="col-12 text-center">
	          <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="set_pay_title();">บันทึก</button>
	        </div>
	        <br>
	      </div>
	    </div>
	  </div>
	</div>

	<script>
		$('input:radio[name="print-radio"]').change(
			function(){
				if ($(this).is(':checked')) {
					checked = $(this).val();
					if(checked == "print"){
						$("#print-option").prop('hidden', false);
						$("#print-option-title").prop('hidden', false);
					}else if(checked == "no"){
						$("#print-option").prop('hidden', true);
						$("#print-option-title").prop('hidden', true);
					}
			}
		}); // show / hide bill-option;

		$('#amount').on("keyup input", function(){
			var price = $('#price').val();
			var amount = parseInt($('#amount').val());
			var total = price*amount;
			$('#total').val(total);
			if(amount > parseInt(min)){
				$.confirm({
					title: 'เตือน',
					content: 'สินค้ามีจำนวนไม่พอใน' + $('#btn-b').text() + ' สินค้ามีจำนวน ' + min,
					backgroundDismiss: true,
					buttons: {
						formSubmit: {
						text: 'ตกลง',
						btnClass: 'btn-regis',
						action: function () {
						}
						}
					}
				});  
				$("#btn-add").attr('disabled',true);
			}else{
				$("#btn-add").attr('disabled',false);
			}	
		});

		$('#price').on("keyup input", function(){
			var price = $('#price').val();
			var amount = $('#amount').val();
			var total = price*amount;
			$('#total').val(total);
		});

		$('#name').on('input', function() {
			var name = $('#name').val();           
			if(name == ""){
				set_default();
			}            
		});  

		$('#discount-money').on("keyup input", function(){
			var dis = $('#discount-money').val(); 
			var net = $('#net-price').val();         
			$('#final-price').val(net - dis);
			var pay = $('#btn-p').text();
			if(pay == "เงินสด"){
				var get = $('#get-money').val();
				var total = $('#final-price').val();        
				if(get - total < 0){           
					$('#change-money').val("");
				}else{
					$('#change-money').val(get - total);
				}   			
			}
		});

		$('#get-money').on("keyup input", function(){
			var get = $('#get-money').val();
			var total = $('#final-price').val();
			if(get - total < 0){
				$('#change-money').val("");
			}else{
				$('#change-money').val(get - total);
			}
		});

		$('#myModal').on('shown.bs.modal', function() {
			$('#discount-money').focus();			
		})
	</script>
</body>
</html>